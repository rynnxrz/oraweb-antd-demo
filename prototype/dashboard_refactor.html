<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OraNutrition - Internal Process & Client Insight Board (PRD v7)</title>
    <link rel="icon" href="data:,">

    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ora: {
                            primary: '#2A9D8F',  // Teal
                            dark: '#264653',     // Dark Blue
                            light: '#E9F5F5',    // Light BG
                            warning: '#E9C46A',  // Yellow
                            danger: '#E76F51',   // Red/Orange
                            accent: '#F4A261'    // Sandy
                        }
                    },
                    fontSize: {
                        'xxs': '0.65rem'
                    }
                }
            }
        }

    </script>
    </script>

    <style>
        html {
            height: 100%;
            width: 100%;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100%;
            width: 100%;
        }

        /* Card & Layout */
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        /* Highlight Animation for Filter Interaction */
        .card.target-highlight {
            border-color: #2A9D8F;
            box-shadow: 0 0 0 4px rgba(42, 157, 143, 0.15);
            transform: scale(1.005);
            z-index: 10;
        }

        .card-header {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }

        .card-footer {
            padding: 0.5rem 1rem;
            border-top: 1px solid #f3f4f6;
            background-color: #f9fafb;
            color: #9ca3af;
            font-size: 0.65rem;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
        }

        .card-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* KPI Card */
        .kpi-card {
            transition: all 0.2s ease-in-out;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .kpi-card.active-filter {
            border-color: #2A9D8F !important;
            background-color: #F0FDFA;
            box-shadow: inset 0 0 0 1px #2A9D8F;
        }

        .kpi-card.active-filter::after {
            content: '\f0b0';
            /* Filter Icon */
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            color: #2A9D8F;
            opacity: 0.2;
            font-size: 2rem;
            pointer-events: none;
        }

        /* Visual Bars (Zombies/Inventory) */
        .progress-bar-bg {
            background-color: #f3f4f6;
            border-radius: 9999px;
            height: 0.5rem;
            width: 100%;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease;
        }

        /* Mini Gantt in Table */
        .stage-pill {
            width: 20%;
            height: 6px;
            margin-right: 2px;
            border-radius: 2px;
            display: inline-block;
            background-color: #e5e7eb;
        }

        .stage-pill.done {
            background-color: #2A9D8F;
        }

        .stage-pill.delay {
            background-color: #E76F51;
        }

        /* Scrollbar */
        .scroller::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scroller::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        /* Tabs */
        .tab-btn {
            transition: all 0.2s;
        }

        .tab-active {
            color: #2A9D8F;
            font-weight: 700;
            text-decoration: underline;
            text-underline-offset: 4px;
        }

        .tab-inactive {
            color: #6b7280;
            font-weight: 500;
        }

        .tab-inactive:hover {
            color: #1f2937;
        }

        /* Traffic Light Dots */
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Desktop Scaler Wrapper */
        #desktop-scaler {
            width: 200%;
            height: 200%;
            transform: scale(0.5);
            transform-origin: top left;
            display: flex;
            flex-direction: row;
            /* Horizontal layout for Sidebar + Main */
            overflow: hidden;
            transition: all 0.3s ease;
            /* Smooth transition when maximizing */
        }

        /* Fullscreen Override Class */
        #desktop-scaler.is-fullscreen-mode {
            width: 100%;
            height: 100%;
            transform: scale(1);
        }
    </style>
    <script>
        // Auto-scale Logic
        function adjustScale() {
            const scaler = document.getElementById('desktop-scaler');
            if (window.innerWidth > 1024) { // Threshold for "Full Screen"
                scaler.classList.add('is-fullscreen-mode');
            } else {
                scaler.classList.remove('is-fullscreen-mode');
            }
        }

        window.addEventListener('resize', adjustScale);
        document.addEventListener('DOMContentLoaded', adjustScale);
    </script>
</head>

<body class="bg-gray-50 h-screen w-full overflow-hidden text-gray-800">
    <div id="desktop-scaler" class="flex h-full overflow-hidden">

        <!-- Sidebar -->
        <aside class="w-14 flex-shrink-0 flex flex-col z-20 shadow-sm transition-all bg-[#297A88]">
            <div class="h-14 flex items-center justify-center bg-white border-b border-gray-100">
                <img src="./assets/images/ora-web/slogo.png" alt="Ora" class="w-10 h-10 object-contain">
            </div>
            <nav class="flex-1 overflow-y-auto flex flex-col items-center gap-0 bg-[#297A88]">
                <!-- Dashboard (Active) -->
                <a href="#" id="nav-btn-dashboard" onclick="switchPage('dashboard'); return false;"
                    class="w-full h-14 flex items-center justify-center bg-[#066070] transition-all shadow-inner">
                    <img src="./assets/images/ora-web/Vector.webp" alt="Dashboard" class="w-6 h-6">
                </a>
                <!-- Contracts -->
                <a href="#" id="nav-btn-contracts" onclick="switchPage('contracts'); return false;"
                    class="w-full h-14 flex items-center justify-center text-white/70 hover:bg-[#066070]/30 transition-all group">
                    <img src="./assets/images/ora-web/Contracts_icon.png" alt="Contracts"
                        class="w-6 h-6 opacity-70 group-hover:opacity-100 transition-opacity">
                </a>
                <!-- Report -->
                <a href="#" id="nav-btn-report" onclick="switchPage('report'); return false;"
                    class="w-full h-14 flex items-center justify-center text-white/70 hover:bg-[#066070]/30 transition-all group">
                    <img src="./assets/images/ora-web/Vector Report.png" alt="Report"
                        class="w-6 h-6 opacity-70 group-hover:opacity-100 transition-opacity">
                </a>
                <!-- Calendar -->
                <a href="#"
                    class="w-full h-14 flex items-center justify-center text-white/70 hover:bg-[#066070]/30 transition-all group">
                    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAAYCAYAAAAVibZIAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAG0SURBVHgBtZXLbcJAEIZnwbyFZHGCm91BSiAduATSQToIHSQdxFRAOiAlUACSVxzgAAiDeL+c+S07OE7sSMZ80nof/j3amdlZEwWYTqfmdrt11uu1Y1nWA8UwHA4NaNHG43E7+E4JTnK5HBWLRTqdTpiqcUZZq0L7FwKP+Xz+ks1mm9weyuWyerlcaLPZ9IUQdoxdrVKpaBiwZ5K/kdx3Go2GSYvF4tVJifP57IxGo2eB+PHuXJc9txORz+cpk8lgk1LBwHeBw/BICanX65YfYyX0TqMUEDgSUVlMAtzP0B34dp9jau92uw9KSLVabSFZLnAf2LZt0Q0E7fxyn0vVWK1WPbTBYGBgjYVdzCeTSTdKEyScfUJVcaU0vWkHj0KhYHjlK6M0sUYPhwNxbH+s7fd7t+eKidTEGuWaf+Nmejtya5+LQv9PE2vUQ/N6yQ0fqXS9tWSE5ko4+7yrtn9BcBJaSTT3PfyBnfc5ISbGHC+JfrlcmlwcSJAdpQkbSf3wK7jlQalUUnGYKSGKEnAahpwU4VC9C/5rarVarceXgUY3cjweP2ez2ZPwF2CcbkTXdYn+C38a9HUI1r8wAAAAAElFTkSuQmCC"
                        alt="Calendar" class="w-6 h-6 opacity-70 group-hover:opacity-100 transition-opacity">
                </a>
            </nav>

        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">

            <!-- Shared Global Header (Profile Only) -->
            <header id="shared-header"
                class="h-14 bg-white border-b border-gray-200 flex items-center justify-end px-6 flex-shrink-0 z-20 relative">
                <div class="flex items-center gap-2">
                    <div
                        class="w-8 h-8 rounded-full bg-ora-primary/20 text-ora-primary flex items-center justify-center text-xs font-bold ring-2 ring-white shadow-sm cursor-pointer hover:ring-ora-primary/50 transition">
                        JD
                    </div>
                </div>
            </header>

            <!-- PAGE: DASHBOARD -->
            <div id="page-dashboard" class="flex-1 flex flex-col overflow-hidden relative h-full">

                <!-- Header Removed -->

                <!-- Scrollable Area -->
                <div id="main-scroller" class="flex-1 overflow-y-auto bg-gray-50 p-6 scroller space-y-8 scroll-smooth">

                    <!-- Dashboard Header & Filters (Moved to Content) -->
                    <div class="mb-6">
                        <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
                            <div>
                                <h1 class="text-xl font-bold text-gray-900" id="header-title" data-i18n="header_title">
                                    OraNutrition ÂÜÖÈÉ®ÊµÅÁ®ã‰∏éÂÆ¢Êà∑Ê¥ûÂØüÊÄªËßà
                                </h1>
                                <p class="text-xs text-gray-500" id="header-update" data-i18n="header_update">‰∏äÊ¨°Êõ¥Êñ∞:
                                    2024-11-28 09:00 AM</p>
                            </div>

                            <div class="flex flex-wrap gap-2 items-center">
                                <!-- Date Range -->
                                <select
                                    class="text-xs border-gray-300 rounded shadow-sm focus:border-ora-primary py-1.5 px-2 bg-gray-50">
                                    <option data-i18n="filter_time_q4">üìÖ Êó∂Èó¥ËåÉÂõ¥: Êú¨Â≠£Â∫¶ (Q4)</option>
                                    <option>üìÖ 2024-06-01 ~ 2024-08-31 (Previous)</option>
                                </select>
                                <!-- Brand -->
                                <select
                                    class="text-xs border-gray-300 rounded shadow-sm focus:border-ora-primary py-1.5 px-2 bg-gray-50">
                                    <option data-i18n="filter_brand_all">ÂìÅÁâå: ÂÖ®ÈÉ®</option>
                                    <option>Little Umbrella</option>
                                    <option>PowerGums</option>
                                </select>
                                <!-- Line Category -->
                                <select
                                    class="text-xs border-gray-300 rounded shadow-sm focus:border-ora-primary py-1.5 px-2 bg-gray-50">
                                    <option data-i18n="filter_line_all">‰∫ßÁ∫øÁ±ªÂûã: ÂÖ®ÈÉ®</option>
                                    <option>Gummies</option>
                                    <option>Powder</option>
                                </select>
                                <!-- Status Filter -->
                                <button
                                    class="bg-[#297A88] text-white px-4 py-1.5 rounded text-sm hover:bg-[#066070] transition shadow-sm font-bold">
                                    <i class="fa-solid fa-rotate-right mr-1"></i> <span
                                        data-i18n="refresh_data">Âà∑Êñ∞Êï∞ÊçÆ</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ========================================== -->
                    <!-- PART 1: INTERNAL EXCEPTION RADAR (PRD 2) -->
                    <!-- ========================================== -->
                    <section>
                        <div class="flex items-center gap-2 mb-4">
                            <h2 class="text-base font-bold text-gray-800 uppercase tracking-wide border-l-4 border-ora-primary pl-3"
                                data-i18n="p1_title">
                                Part 1. ÂÜÖÈÉ®ÂºÇÂ∏∏Èõ∑Ëææ (Internal Exception Radar)</h2>
                            <span class="text-xs text-gray-400 italic ml-2"><i
                                    class="fa-solid fa-circle-info mr-1"></i><span data-i18n="p1_subtitle">Click
                                    cards to filter details</span></span>
                        </div>

                        <!-- Widget 1A: KPI Summary Bar (PRD 2.1) -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <!-- Card 1: Lead Time Breach -->
                            <div class="card p-4 border-l-4 border-red-500 cursor-pointer hover:shadow-md transition kpi-card"
                                id="card-lead-time" onclick="toggleKpiFilterP1('card-lead-time', 'leadtime')"
                                title="Based on 142 contracts">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 mb-1" data-i18n="kpi_lead_title">
                                            Lead Time Breach</div>
                                        <div class="text-xs text-gray-500 uppercase font-bold" data-i18n="kpi_lead_sub">
                                            Êï¥‰ΩìÂë®ÊúüË∂ÖÂá∫ÂÜÖÈÉ®ÁõÆÊ†á</div>
                                        <div class="text-2xl font-bold text-red-600 mt-1">18 <span
                                                class="text-sm text-gray-400 font-normal">/ 142</span></div>
                                    </div>
                                    <div class="bg-red-100 p-2 rounded-full text-red-500"><i
                                            class="fa-solid fa-clock"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-red-500 font-medium"><i class="fa-solid fa-arrow-up"></i>
                                    5 vs
                                    last week</div>
                                <div class="mt-1 text-[10px] text-gray-400">Stage SLA > ÁõÆÊ†á</div>
                            </div>

                            <!-- Card 2: Payment Blocked -->
                            <div class="card p-4 border-l-4 border-orange-400 cursor-pointer hover:shadow-md transition kpi-card"
                                id="card-payment" onclick="toggleKpiFilterP1('card-payment', 'money')"
                                title="Based on 45 active contracts">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 mb-1" data-i18n="kpi_pay_title">
                                            Payment Blocked</div>
                                        <div class="text-xs text-gray-500 uppercase font-bold" data-i18n="kpi_pay_sub">
                                            Êî∂Ê¨æÁéØËäÇÊúâÈòªÂ°û</div>
                                        <div class="text-2xl font-bold text-orange-500 mt-1">8 <span
                                                class="text-sm text-gray-400 font-normal">Contracts</span></div>
                                    </div>
                                    <div class="bg-orange-100 p-2 rounded-full text-orange-500"><i
                                            class="fa-solid fa-hand-holding-dollar"></i></div>
                                </div>
                                <div class="mt-2 text-xs text-orange-500 font-medium">High Priority</div>
                                <div class="mt-1 text-[10px] text-gray-400">Ê¨æÈ°πÂæÖÁ°ÆËÆ§ > 3 Â§©</div>
                            </div>

                            <!-- Card 3: Material Risk -->
                            <div class="card p-4 border-l-4 border-yellow-400 cursor-pointer hover:shadow-md transition kpi-card"
                                id="card-material" onclick="toggleKpiFilterP1('card-material', 'materials')"
                                title="Based on 45 active contracts">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 mb-1" data-i18n="kpi_mat_title">
                                            Material Risk</div>
                                        <div class="text-xs text-gray-500 uppercase font-bold" data-i18n="kpi_mat_sub">
                                            Áâ©ÊñôÂáÜÂ§áÂ≠òÂú®È£éÈô©</div>
                                        <div class="text-2xl font-bold text-yellow-600 mt-1">12 <span
                                                class="text-sm text-gray-400 font-normal">Contracts</span></div>
                                    </div>
                                    <div class="bg-yellow-100 p-2 rounded-full text-yellow-600"><i
                                            class="fa-solid fa-boxes-stacked"></i></div>
                                </div>
                                <div class="mt-2 text-xs text-gray-500 font-medium">Requires Attention</div>
                                <div class="mt-1 text-[10px] text-gray-400">Áâ©ÊñôÊú™Âà∞+‰∏¥ËøëÊéí‰∫ß</div>
                            </div>

                            <!-- Card 4: Data Issues -->
                            <div class="card p-4 border-l-4 border-gray-400 cursor-pointer hover:shadow-md transition kpi-card"
                                id="card-data" onclick="toggleKpiFilterP1('card-data', 'data_issue')"
                                title="Based on all records">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <div class="text-sm font-bold text-gray-700 mb-1" data-i18n="kpi_data_title">
                                            Data Quality</div>
                                        <div class="text-xs text-gray-500 uppercase font-bold" data-i18n="kpi_data_sub">
                                            Êï∞ÊçÆËÆ∞ÂΩïÈúÄË°•ÂÖÖ</div>
                                        <div class="text-2xl font-bold text-gray-600 mt-1">15 <span
                                                class="text-sm text-gray-400 font-normal">Records</span></div>
                                    </div>
                                    <div class="bg-gray-100 p-2 rounded-full text-gray-600"><i
                                            class="fa-solid fa-database"></i>
                                    </div>
                                </div>
                                <div class="mt-2 text-xs text-red-500 font-medium">Affects Forecast</div>
                                <div class="mt-1 text-[10px] text-gray-400">Â≠óÊÆµÁº∫Â§±/ÂºÇÂ∏∏</div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- Widget P1-B: Key Contracts Stage Overview (Merged 1B & 1C) -->
                            <div id="widget-p1b" class="card lg:col-span-2">
                                <div class="card-header">
                                    <div class="flex items-center gap-4">
                                        <h3 class="card-title"><i class="fa-solid fa-list-check text-ora-primary"></i>
                                            <span data-i18n="p1b_title">P1-B.
                                                ÂÖ≥ÈîÆËÆ¢ÂçïÈò∂ÊÆµÊÄªËßà (Key Contracts)</span>
                                        </h3>
                                        <div class="flex bg-gray-100 rounded p-0.5 space-x-1">
                                            <button onclick="switchView('p1b', 'list')" id="btn-p1b-view-list"
                                                class="px-2 py-0.5 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200"
                                                data-i18n="btn_list">ÂàóË°®</button>
                                            <button onclick="switchView('p1b', 'graph')" id="btn-p1b-view-graph"
                                                class="px-2 py-0.5 text-xs rounded text-gray-500 hover:text-gray-800"
                                                data-i18n="btn_graph">ÂõæË°®</button>
                                        </div>
                                    </div>
                                    <!-- Internal Filters -->
                                    <div class="flex space-x-2 text-xs">
                                        <span class="text-gray-400 self-center">Filter:</span>
                                        <button onclick="filterP1B('all')" class="tab-btn tab-active" id="btn-p1b-all"
                                            data-i18n="Tab_all">ÂÖ®ÈÉ®</button>
                                        <button onclick="filterP1B('blocker')" class="tab-btn tab-inactive"
                                            id="btn-p1b-blocker" data-i18n="Tab_blocker">ÂæÖËß£ÂÜ≥ (Blocker)</button>
                                        <button onclick="filterP1B('delay')" class="tab-btn tab-inactive"
                                            id="btn-p1b-delay" data-i18n="Tab_delay">‰∏•ÈáçË∂ÖÊó∂</button>
                                    </div>
                                </div>

                                <!-- List View -->
                                <div class="p-0 overflow-x-auto flex-1" id="p1b-view-list">
                                    <table class="w-full text-left text-xs">
                                        <thead class="bg-gray-50 text-gray-500 uppercase border-b border-gray-200">
                                            <tr>
                                                <th class="px-4 py-3 font-semibold" data-i18n="th_contract">ÂêàÂêå / ÂìÅÁâå</th>
                                                <th class="px-4 py-3 font-semibold" data-i18n="th_stage">ÂΩìÂâçÈò∂ÊÆµ</th>
                                                <th class="px-4 py-3 font-semibold" data-i18n="th_delay">ÊúÄ‰∏•ÈáçÈò∂ÊÆµ (Delay)
                                                </th>
                                                <th class="px-4 py-3 font-semibold" data-i18n="th_status">Áä∂ÊÄÅ / ÂéüÂõ†</th>
                                                <th class="px-4 py-3 font-semibold text-right" data-i18n="th_time">Êó∂Èó¥
                                                    (Á≠æÁ∫¶/Êõ¥Êñ∞)</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-gray-100" id="p1b-tbody">
                                            <!-- Mock Data: Blocker - Money -->
                                            <tr class="hover:bg-gray-50 row-blocker row-money">
                                                <td class="px-4 py-3">
                                                    <div class="font-bold text-gray-800">C2411-003</div>
                                                    <div class="text-[10px] text-gray-500">Little Umbrella</div>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px]">S1
                                                        Ê¨æÈ°π</span></td>
                                                <td class="px-4 py-3"><span class="text-red-500 font-bold">+45d</span>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="bg-red-50 text-red-600 px-2 py-0.5 rounded border border-red-100 text-[10px]">Ê¨æÈ°πÊú™Âà∞</span>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="font-bold">45d</div>
                                                    <div class="text-[10px] text-gray-400">2d ago</div>
                                                </td>
                                            </tr>
                                            <!-- Mock Data: Blocker - Materials -->
                                            <tr class="hover:bg-gray-50 row-blocker row-materials">
                                                <td class="px-4 py-3">
                                                    <div class="font-bold text-gray-800">C2411-008</div>
                                                    <div class="text-[10px] text-gray-500">PowerGums</div>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px]">S2
                                                        Áâ©Êñô</span></td>
                                                <td class="px-4 py-3"><span
                                                        class="text-orange-500 font-bold">+20d</span>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="bg-orange-50 text-orange-600 px-2 py-0.5 rounded border border-orange-100 text-[10px]">Áâ©ÊñôÊú™ÈΩê</span>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="font-bold">20d</div>
                                                    <div class="text-[10px] text-gray-400">1d ago</div>
                                                </td>
                                            </tr>
                                            <!-- Mock Data: SLA Breach (Lead Time) -->
                                            <tr class="hover:bg-gray-50 row-delay row-leadtime">
                                                <td class="px-4 py-3">
                                                    <div class="font-bold text-gray-800">C2410-001</div>
                                                    <div class="text-[10px] text-gray-500">Vitality</div>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-[10px]">S4
                                                        Áîü‰∫ß</span></td>
                                                <td class="px-4 py-3"><span class="text-red-500 font-bold">+15d</span>
                                                </td>
                                                <td class="px-4 py-3"><span
                                                        class="text-gray-500 text-[10px]">Ë∂ÖÂá∫ÂÜÖÈÉ®ÁõÆÊ†á</span>
                                                </td>
                                                <td class="px-4 py-3 text-right">
                                                    <div class="font-bold">60d</div>
                                                    <div class="text-[10px] text-gray-400">Active</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    <div class="p-2 text-center text-xs text-gray-400 border-t border-gray-100">
                                        ÂàóË°®Êåâ‰∏•ÈáçÁ®ãÂ∫¶ÊéíÂ∫èÔºå‰ºòÂÖàÊòæÁ§∫ÂæÖËß£ÂÜ≥‰∫ãÈ°π„ÄÇ‰ªÖÂ±ïÁ§∫Ââç 20 ‰ªΩÊúÄÈúÄË¶ÅÂÖ≥Ê≥®ÁöÑËÆ¢Âçï„ÄÇ
                                    </div>
                                </div>

                                <!-- Graph View (Matrix) -->
                                <div id="p1b-view-graph" class="hidden p-4 overflow-x-auto">
                                    <div class="min-w-[500px]">
                                        <!-- Header -->
                                        <div
                                            class="grid grid-cols-6 gap-1 mb-2 text-xs font-bold text-gray-500 text-center">
                                            <div class="text-left pl-2">ÂêàÂêå</div>
                                            <div>S1 Ê¨æÈ°π</div>
                                            <div>S2 Áâ©Êñô</div>
                                            <div>S3 Á≠âÂæÖ</div>
                                            <div>S4 Áîü‰∫ß</div>
                                            <div>S5 ÂèëË¥ß</div>
                                        </div>
                                        <!-- Row 1 -->
                                        <div class="grid grid-cols-6 gap-1 mb-1 text-xs">
                                            <div class="flex flex-col justify-center pl-2">
                                                <span class="font-bold">C2411-003</span>
                                                <span class="text-[10px] text-gray-400">Little Umbrella</span>
                                            </div>
                                            <div
                                                class="bg-red-500 text-white flex flex-col items-center justify-center p-1 rounded">
                                                <span class="font-bold">+45</span>
                                                <span class="text-[8px]">Ê¨æÈ°πÊú™Âà∞</span>
                                            </div>
                                            <div class="bg-gray-100 rounded"></div>
                                            <div class="bg-gray-100 rounded"></div>
                                            <div class="bg-gray-100 rounded"></div>
                                            <div class="bg-gray-100 rounded"></div>
                                        </div>
                                        <!-- Row 2 -->
                                        <div class="grid grid-cols-6 gap-1 mb-1 text-xs">
                                            <div class="flex flex-col justify-center pl-2">
                                                <span class="font-bold">C2411-008</span>
                                                <span class="text-[10px] text-gray-400">PowerGums</span>
                                            </div>
                                            <div
                                                class="bg-green-500 text-white flex items-center justify-center rounded font-bold">
                                                OK</div>
                                            <div
                                                class="bg-orange-500 text-white flex flex-col items-center justify-center p-1 rounded">
                                                <span class="font-bold">+20</span>
                                                <span class="text-[8px]">Áâ©ÊñôÊú™ÈΩê</span>
                                            </div>
                                            <div class="bg-gray-100 rounded"></div>
                                            <div class="bg-gray-100 rounded"></div>
                                            <div class="bg-gray-100 rounded"></div>
                                        </div>
                                        <!-- Row 3 -->
                                        <div class="grid grid-cols-6 gap-1 mb-1 text-xs">
                                            <div class="flex flex-col justify-center pl-2">
                                                <span class="font-bold">C2410-001</span>
                                                <span class="text-[10px] text-gray-400">Vitality</span>
                                            </div>
                                            <div
                                                class="bg-green-500 text-white flex items-center justify-center rounded font-bold">
                                                OK</div>
                                            <div
                                                class="bg-green-500 text-white flex items-center justify-center rounded font-bold">
                                                OK</div>
                                            <div
                                                class="bg-green-500 text-white flex items-center justify-center rounded font-bold">
                                                OK</div>
                                            <div
                                                class="bg-red-400 text-white flex flex-col items-center justify-center p-1 rounded">
                                                <span class="font-bold">+15</span>
                                                <span class="text-[8px]">Áîü‰∫ßÂª∂Ëøü</span>
                                            </div>
                                            <div class="bg-gray-100 rounded"></div>
                                        </div>
                                    </div>
                                    <div class="mt-4 text-xs text-gray-400 text-center">
                                        ÂΩ©Ëâ≤Ê†ºÂ≠êË°®Á§∫ËØ•Èò∂ÊÆµÊØîÂÜÖÈÉ®ÁõÆÊ†áÂ§öÁî®ÁöÑÂ§©Êï∞„ÄÇ
                                    </div>
                                </div>
                            </div>

                            <!-- Widget P1-C: Zombie & Inventory (Renamed from 1D) -->
                            <div id="widget-p1c" class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-skull text-gray-500"></i> <span
                                            data-i18n="p1c_title">P1-C. ÂÉµÂ∞∏ÂêàÂêå‰∏éÂ∫ìÂ≠ò</span>
                                    </h3>
                                    <div class="flex bg-gray-100 rounded p-0.5 space-x-1">
                                        <button onclick="toggleZombieView('contracts')" id="btn-zombie-contracts"
                                            class="px-3 py-1 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200"
                                            data-i18n="btn_zombie_contracts">ÂÅúÊªû‰∏≠ÁöÑÂêàÂêå</button>
                                        <button onclick="toggleZombieView('inventory')" id="btn-zombie-inventory"
                                            class="px-3 py-1 text-xs rounded text-gray-500 hover:text-gray-800"
                                            data-i18n="btn_zombie_inventory">ÊªûÁïôÊàêÂìÅ/ÂçäÊàêÂìÅ</button>
                                    </div>
                                </div>
                                <div class="p-4 flex-1 overflow-y-auto">
                                    <!-- View: Contracts -->
                                    <div id="view-zombie-contracts" class="space-y-3">
                                        <div class="text-xs text-gray-400 mb-2">Ë∂ÖËøá 45 Â§©Êó†Êõ¥Êñ∞ (Inactive > 45d)</div>
                                        <div class="space-y-2">
                                            <div>
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="font-bold text-gray-700">C2408-002 (Vitality)</span>
                                                    <span class="text-red-500 font-bold">120d</span>
                                                </div>
                                                <div class="w-full bg-gray-100 rounded-full h-2"
                                                    title="120d (Inactive)">
                                                    <div class="bg-gray-400 h-2 rounded-full" style="width: 100%"></div>
                                                </div>
                                            </div>
                                            <div>
                                                <div class="flex justify-between text-xs mb-1">
                                                    <span class="font-bold text-gray-700">C2409-015 (Muscle)</span>
                                                    <span class="text-red-500 font-bold">95d</span>
                                                </div>
                                                <div class="w-full bg-gray-100 rounded-full h-2" title="95d (Inactive)">
                                                    <div class="bg-gray-400 h-2 rounded-full" style="width: 80%"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- View: Inventory -->
                                    <div id="view-zombie-inventory" class="hidden space-y-3">
                                        <div class="text-xs text-gray-400 mb-2">ÂèëË¥ßÈÄæÊúüË∂ÖËøá 7 Â§© (Overdue > 7d)</div>
                                        <ul class="space-y-2">
                                            <li class="flex justify-between items-center p-2 bg-red-50 rounded border border-red-100"
                                                title="Produced: 5000, Shipped: 0, Stuck: 5000">
                                                <div>
                                                    <div class="text-xs font-bold text-gray-800">C2410-001 (Gummies)
                                                    </div>
                                                    <div class="text-[10px] text-red-500">Produced but not shipped (15d)
                                                    </div>
                                                </div>
                                                <div class="text-xs font-bold text-gray-800">5k Units</div>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="card-footer">Showing Top 5 by Inactive/Overdue Days</div>
                            </div>

                            <!-- Widget P1-D: Data Quality (Renamed from 1E) -->
                            <!-- Widget P1-D: Data Quality Monitor (Left-Right Layout) -->
                            <div id="widget-p1d"
                                class="card bg-white border border-gray-200 shadow-sm rounded-lg lg:col-span-3 flex flex-col h-96">
                                <div
                                    class="card-header flex justify-between items-center mb-2 px-4 py-3 border-b border-gray-100">
                                    <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                                        <i class="fas fa-database text-purple-600"></i> <span
                                            data-i18n="p1d_title">Êï∞ÊçÆËÆ∞ÂΩïÂÆåÊï¥Â∫¶ (Data Quality)</span>
                                    </h3>
                                    <span class="text-xs text-gray-500">Last Update: 10 mins ago</span>
                                </div>

                                <div class="flex flex-1 overflow-hidden p-4 gap-4">
                                    <!-- Left: Charts (50%) -->
                                    <div class="w-1/2 flex flex-col justify-center">
                                        <div class="flex flex-1 gap-2 items-center justify-center">
                                            <!-- Chart 1: Good vs Bad -->
                                            <div class="w-1/2 relative h-40">
                                                <canvas id="dataQualityGoodBad"></canvas>
                                                <div
                                                    class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                                    <div class="text-center">
                                                        <span class="text-2xl font-bold text-gray-800">92%</span><br>
                                                        <span class="text-xs text-gray-500">ÂÆåÊï¥Â∫¶</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Chart 2: Issue Types -->
                                            <div class="w-1/2 relative h-40">
                                                <canvas id="dataQualityChart"></canvas>
                                            </div>
                                        </div>
                                        <div class="mt-2 text-xs text-gray-500 text-center bg-gray-50 p-2 rounded">
                                            <i
                                                class="fas fa-info-circle mr-1"></i>Â∑¶‰æßÂ±ïÁ§∫Êï¥‰ΩìËÆ∞ÂΩïÂÆåÊï¥Â∫¶ÔºåÂè≥‰æßÂ±ïÁ§∫ÈóÆÈ¢òÁ±ªÂûãÂàÜÂ∏É„ÄÇ‰∏ÄÊù°ËÆ∞ÂΩïÂèØËÉΩÂêåÊó∂ÂåÖÂê´Â§öÁßçÈóÆÈ¢ò„ÄÇ
                                        </div>
                                    </div>

                                    <!-- Right: Detail List (50%) -->
                                    <div
                                        class="w-1/2 flex flex-col bg-white border border-gray-100 rounded-lg shadow-sm h-full">
                                        <div
                                            class="px-3 py-2 border-b border-gray-100 flex justify-between items-center bg-gray-50 rounded-t-lg">
                                            <span class="font-bold text-xs text-gray-700">ÈóÆÈ¢òÂêàÂêåÂàóË°® (Issue List)</span>
                                            <span id="p1d-current-filter"
                                                class="text-xs px-2 py-0.5 bg-purple-100 text-purple-700 rounded-full font-medium">ÂΩìÂâçÁ≠õÈÄâ:
                                                ÂÖ®ÈÉ®ÈóÆÈ¢ò</span>
                                        </div>
                                        <div class="flex-1 overflow-y-auto p-0">
                                            <table class="w-full text-left border-collapse">
                                                <thead
                                                    class="sticky top-0 bg-gray-50 text-xs font-semibold text-gray-500 z-10">
                                                    <tr>
                                                        <th class="p-2 border-b">ÂêàÂêå/‰∫ßÂìÅ (Contract)</th>
                                                        <th class="p-2 border-b">ÈóÆÈ¢ò (Issue)</th>
                                                        <th class="p-2 border-b">Êõ¥Êñ∞ (Update)</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="p1d-tbody" class="text-xs divide-y divide-gray-100">
                                                    <!-- Mock Data Rows -->
                                                    <tr class="hover:bg-gray-50 transition-colors row-issue-date">
                                                        <td class="p-2">
                                                            <div class="font-medium text-gray-800">C-2024-001</div>
                                                            <div class="text-gray-500 scale-90 origin-left">Gummies
                                                            </div>
                                                        </td>
                                                        <td class="p-2 text-red-600"><i
                                                                class="fas fa-calendar-times mr-1"></i>Áº∫Â∞ëÂèëË¥ßÊó•Êúü</td>
                                                        <td class="p-2 text-gray-500">10m ago<br>by System</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50 transition-colors row-issue-qty">
                                                        <td class="p-2">
                                                            <div class="font-medium text-gray-800">C-2024-005</div>
                                                            <div class="text-gray-500 scale-90 origin-left">Powder</div>
                                                        </td>
                                                        <td class="p-2 text-orange-600"><i
                                                                class="fas fa-balance-scale-right mr-1"></i>Êï∞Èáè‰∏ç‰∏ÄËá¥</td>
                                                        <td class="p-2 text-gray-500">2h ago<br>by John</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50 transition-colors row-issue-date">
                                                        <td class="p-2">
                                                            <div class="font-medium text-gray-800">C-2024-008</div>
                                                            <div class="text-gray-500 scale-90 origin-left">Liquids
                                                            </div>
                                                        </td>
                                                        <td class="p-2 text-red-600"><i
                                                                class="fas fa-calendar-times mr-1"></i>Áº∫Â∞ëÂèëË¥ßÊó•Êúü</td>
                                                        <td class="p-2 text-gray-500">1d ago<br>by System</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50 transition-colors row-issue-other">
                                                        <td class="p-2">
                                                            <div class="font-medium text-gray-800">C-2024-012</div>
                                                            <div class="text-gray-500 scale-90 origin-left">Capsules
                                                            </div>
                                                        </td>
                                                        <td class="p-2 text-gray-600"><i
                                                                class="fas fa-exclamation-circle mr-1"></i>‰ªòÊ¨æÊó•ÊúüÁº∫Â§±</td>
                                                        <td class="p-2 text-gray-500">3d ago<br>by Finance</td>
                                                    </tr>
                                                    <tr class="hover:bg-gray-50 transition-colors row-issue-logic">
                                                        <td class="p-2">
                                                            <div class="font-medium text-gray-800">C-2024-015</div>
                                                            <div class="text-gray-500 scale-90 origin-left">Gummies
                                                            </div>
                                                        </td>
                                                        <td class="p-2 text-red-600"><i
                                                                class="fas fa-clock mr-1"></i>Êó∂Èó¥È°∫Â∫èÂºÇÂ∏∏
                                                        </td>
                                                        <td class="p-2 text-gray-500">5m ago<br>by System</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                            <!-- Empty State (Hidden by default) -->
                                            <div id="p1d-empty-state"
                                                class="hidden flex flex-col items-center justify-center h-full text-gray-400">
                                                <i class="fas fa-check-circle text-4xl text-green-500 mb-2"></i>
                                                <p class="text-sm">ËÆ∞ÂΩïÂÆåÊï¥ ¬∑ Êó†ÈúÄË°•ÂÖÖ</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div
                                    class="px-4 py-2 border-t border-gray-100 text-xs text-gray-400 flex justify-between items-center bg-gray-50 rounded-b-lg">
                                    <span><i
                                            class="fas fa-info-circle mr-1"></i>Â∑¶‰æßÂ±ïÁ§∫Êï¥‰ΩìÊï∞ÊçÆËÆ∞ÂΩïÁöÑÂÆåÊï¥Â∫¶ÔºåÂè≥‰æßÂàóÂá∫ÂÖ∑‰ΩìÊúâÈóÆÈ¢òÁöÑÂêàÂêå‰∏é‰∫ßÂìÅÔºå‰æø‰∫éÂø´ÈÄüÂõûÊ∫ØÂπ∂Ë°•ÂÖ®‰ø°ÊÅØ„ÄÇÂΩìÂâç
                                        Demo ÁéØÂ¢É‰ΩøÁî®ÁöÑÊòØÁ§∫‰æãÊï∞ÊçÆ„ÄÇ</span>
                                </div>
                            </div>

                        </div>
                    </section>

                    <!-- ========================================== -->
                    <!-- PART 2: PROCESS LEAD TIME (Collapsed)  -->
                    <!-- ========================================== -->
                    <!-- ========================================== -->
                    <!-- PART 2: PROCESS LEAD TIME (PRD 3)      -->
                    <!-- ========================================== -->
                    <section class="mt-8">
                        <div class="flex items-center gap-2 mb-4">
                            <h2 class="text-base font-bold text-gray-800 uppercase tracking-wide border-l-4 border-secondary pl-3"
                                data-i18n="p2_title">
                                Part 2. ‰∫§‰ªòÂë®ÊúüÊ∑±Â∫¶ÈÄèËßÜ (Lead Time Deep Dive)</h2>
                            <span class="text-xs text-gray-400 italic ml-2"><i
                                    class="fa-solid fa-circle-info mr-1"></i><span data-i18n="p2_subtitle">Process
                                    Cycle vs Target</span></span>
                        </div>

                        <!-- P0: Contract Entry Latency (Banner) -->
                        <div
                            class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-6 flex items-center justify-between shadow-sm">
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600">
                                    <i class="fa-solid fa-stopwatch-20"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-800">ÂêàÂêåÂΩïÂÖ•ÊèêÈÜí</div>
                                    <div class="text-xs text-gray-600">Á∫¶ 15% ÁöÑÂêàÂêåÂú®Á≠æÁ∫¶Âêé 3 Â§©ÊâçÂΩïÂÖ•Á≥ªÁªü„ÄÇ</div>
                                </div>
                            </div>
                            <button
                                class="text-xs bg-white border border-gray-300 px-3 py-1 rounded font-bold text-gray-600 hover:bg-gray-50">Êü•ÁúãÊòéÁªÜ</button>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

                            <!-- P1: Lead Time Waterfall -->
                            <div class="card lg:col-span-2">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-industry text-secondary"></i> <span
                                            data-i18n="p3b_title">3B.
                                            ‰∫ßËÉΩÂà©Áî®Áéá</span></h3>
                                    <span class="text-xs text-gray-400">Âπ≥ÂùáÂ§©Êï∞ (Avg Days)</span>
                                </div>
                                <div class="p-4 h-64">
                                    <canvas id="p1WaterfallChart"></canvas>
                                </div>
                                <div class="card-footer flex justify-between">
                                    <span>Êï¥‰Ωì‰∏≠‰ΩçÂë®ÊúüÔºö42 Â§©</span>
                                    <span>Âü∫‰∫éÂ∑≤ÂÆåÊàêÁöÑÂêàÂêå</span>
                                </div>
                                <div class="px-4 pb-2 text-xs text-gray-500">ÁõÆÂâç‰ªéÊî∂ÈΩêË¥ßÊ¨æÂà∞ÂèëË¥ßÂπ≥ÂùáÁ∫¶ 42 Â§©ÔºåÂÖ∂‰∏≠Áîü‰∫ßÂíåÂèëË¥ß‰∏§‰∏™Èò∂ÊÆµËÄóÊó∂ÊúÄÈïø„ÄÇ</div>
                            </div>

                            <!-- P2: Stage SLA Breach Rate -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-chart-column text-red-500"></i> P2.
                                        ÂêÑÈò∂ÊÆµË∂ÖÂá∫ÂÜÖÈÉ®ÁõÆÊ†áÁöÑÊØî‰æã</h3>
                                </div>
                                <div class="p-4 h-64 flex flex-col">
                                    <div class="flex-1 relative">
                                        <canvas id="p2BreachChart"></canvas>
                                    </div>
                                    <div class="mt-2 text-xs text-gray-600 border-t pt-2">
                                        <div class="font-bold mb-1">‰∏ªË¶ÅÁì∂È¢à (Top Bottlenecks):</div>
                                        <div class="flex justify-between"><span>1. Áâ©ÊñôÂáÜÂ§áÈò∂ÊÆµ</span> <span
                                                class="text-red-600 font-bold">68% Ë∂ÖÂá∫ÁõÆÊ†á</span></div>
                                        <div class="flex justify-between"><span>2. Áîü‰∫ßÈò∂ÊÆµ</span> <span
                                                class="text-orange-500 font-bold">45% Ë∂ÖÂá∫ÁõÆÊ†á</span></div>
                                    </div>
                                </div>
                            </div>

                            <!-- P3: Plan Adherence -->
                            <div class="card lg:col-span-2">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-calendar-check text-green-600"></i> P3.
                                        ÂêÑ‰∫ßÁ∫øÊåâÊó∂‰∫§‰ªòÊÉÖÂÜµ</h3>
                                </div>
                                <div class="p-4 h-64">
                                    <canvas id="p3AdherenceChart"></canvas>
                                </div>
                                <div class="card-footer">ËΩØÁ≥ñÂíåËÉ∂ÂõäÁöÑ‰∫§‰ªòÊúÄÁ®≥ÂÆöÔºåÁ≤âÂâÇÂª∂ËøüËæÉÂ§ö„ÄÇ</div>
                            </div>

                            <!-- P4: Materials vs Production -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-boxes-stacked text-ora-warning"></i>
                                        P4.
                                        ÂºÄÂ∑•ÂâçÁâ©ÊñôÂáÜÂ§áÊÉÖÂÜµ</h3>
                                </div>
                                <div class="p-4 flex flex-col h-full">
                                    <div class="h-40 relative">
                                        <canvas id="p4MaterialChart"></canvas>
                                        <div
                                            class="absolute inset-0 flex items-center justify-center flex-col pointer-events-none">
                                            <span class="text-2xl font-bold text-gray-700">85%</span>
                                            <span class="text-[10px] text-gray-400">ÂáÜÂ§áÂ∞±Áª™</span>
                                        </div>
                                    </div>
                                    <div class="text-center text-xs text-gray-500 mt-1 mb-2">ÂΩìÂâçÁ∫¶ 85% ÁöÑÁîü‰∫ßÊâπÊ¨°Âú®ÂºÄÂ∑•ÂâçÁâ©ÊñôÂ∑≤ÂáÜÂ§áÂ∞±Áª™„ÄÇ
                                    </div>
                                    <div class="flex-1 mt-2 overflow-y-auto border-t pt-2">
                                        <div class="text-xs font-bold text-gray-700 mb-2">È£éÈô©ÊâπÊ¨°ÔºàÂºÄÂ∑•Êó∂Áâ©ÊñôÊú™ÂÆåÂÖ®Âà∞‰ΩçÔºâ</div>
                                        <ul class="space-y-1">
                                            <li class="flex justify-between text-xxs text-gray-600"><span>C2411-05
                                                    (Gummies)</span> <span class="text-red-500 font-bold">-2d</span>
                                            </li>
                                            <li class="flex justify-between text-xxs text-gray-600"><span>C2411-08
                                                    (Powder)</span> <span class="text-red-500 font-bold">-1d</span></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- G1: Factory Growth -->
                        <div class="card mb-8">
                            <div class="card-header">
                                <h3 class="card-title"><i class="fa-solid fa-arrow-trend-up text-ora-primary"></i> G1.
                                    Â∑•ÂéÇ‰∫ßÂá∫‰∏éÊïàÁéáÊèêÂçá
                                </h3>
                                <span class="text-xs text-gray-400">Â≠£Â∫¶Âá∫Ë¥ßË∂ãÂäø</span>
                            </div>
                            <div class="p-6 grid grid-cols-1 lg:grid-cols-4 gap-6">
                                <!-- Chart -->
                                <div class="lg:col-span-3 h-64">
                                    <canvas id="g1GrowthChart"></canvas>
                                    <div class="text-center text-xs text-gray-500 mt-2">Q4 È¢ÑËÆ°Âá∫Ë¥ß 120 ‰∏á‰ª∂ÔºåËæÉ‰∏äÂ≠£Â∫¶Â¢ûÈïø
                                        15%ÔºõÂπ≥Âùá‰∫§‰ªòÊó∂Èó¥ÊØîÂàùÂßãÈò∂ÊÆµÁº©Áü≠Á∫¶
                                        3 Â§©„ÄÇ</div>
                                </div>
                                <!-- KPIs -->
                                <div class="space-y-4">
                                    <div class="bg-gray-50 p-4 rounded border border-gray-100">
                                        <div class="text-xs text-gray-500 uppercase font-bold">Êú¨Â≠£Â∫¶Âá∫Ë¥ßÊÄªÈáè</div>
                                        <div class="text-2xl font-bold text-gray-800 mt-1">1.2M</div>
                                        <div class="text-xs text-green-600 mt-1"><i class="fa-solid fa-arrow-up"></i>
                                            15%
                                            QoQ
                                        </div>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded border border-gray-100">
                                        <div class="text-xs text-gray-500 uppercase font-bold">Âπ≥Âùá‰∫§‰ªòÊó∂Èó¥</div>
                                        <div class="text-2xl font-bold text-gray-800 mt-1">42d</div>
                                        <div class="text-xs text-green-600 mt-1"><i class="fa-solid fa-arrow-down"></i>
                                            3d
                                            vs
                                            Baseline</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- ========================================== -->
                    <!-- PART 3: CLIENT & OPPORTUNITY RADAR (PRD 4) -->
                    <!-- ========================================== -->
                    <section class="pb-10 mt-8">
                        <div class="flex items-center gap-2 mb-4">
                            <h2 class="text-base font-bold text-gray-800 uppercase tracking-wide border-l-4 border-secondary pl-3"
                                data-i18n="p3_title">
                                Part 3. ÂÆ¢Êà∑‰∏é‰∫ßËÉΩÈõ∑Ëææ (Client & Capacity Radar)</h2>
                            <span class="text-xs text-gray-400">Q3 2024 vs Q4 2024</span>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                            <!-- 3A: Client Risk -->
                            <div class="card lg:col-span-2">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fa-solid fa-user-shield text-ora-primary"></i> <span
                                            data-i18n="p3a_title">3A.
                                            ÂÆ¢Êà∑È£éÈô©È¢ÑË≠¶</span>
                                    </h3>
                                </div>
                                <div class="p-4">
                                    <!-- Visual: Bar Chart for Vol Comparison -->
                                    <div class="w-full h-40">
                                        <canvas id="clientRiskChart"></canvas>
                                        <div class="text-center text-xs text-gray-500 mt-2">Á∫¢Ëâ≤Ë°®Á§∫Êú¨Â≠£Â∫¶ÂÆåÂÖ®Ê≤°‰∏ãÂçïÔºåÊ©ôËâ≤Ë°®Á§∫ËÆ¢ÂçïÈáèÊòéÊòæ‰∏ãÈôç„ÄÇ
                                        </div>
                                    </div>
                                    <!-- List: Details -->
                                    <div class="w-full overflow-x-auto mt-4">
                                        <table class="w-full text-left text-xs">
                                            <thead class="bg-gray-50 text-gray-500 uppercase border-b border-gray-200">
                                                <tr>
                                                    <th class="px-4 py-2">ÂìÅÁâå</th>
                                                    <th class="px-4 py-2">Áä∂ÊÄÅ</th>
                                                    <th class="px-4 py-2 text-right">ÊúÄËøëÂá†Â≠£Âá∫Ë¥ßÈáè (ÂØπÊØî)</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-100">
                                                <tr>
                                                    <td class="px-4 py-2 font-bold">Vitality</td>
                                                    <td class="px-4 py-2"><span
                                                            class="bg-red-100 text-red-700 px-2 py-0.5 rounded-full text-xxs">Êú¨Â≠£Êú™‰∏ãÂçï</span>
                                                    </td>
                                                    <td class="px-4 py-2 text-right text-gray-400">60k <i
                                                            class="fa-solid fa-arrow-right text-gray-300 mx-1"></i>
                                                        <span class="text-red-600 font-bold">0</span>
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td class="px-4 py-2 font-bold">Muscle</td>
                                                    <td class="px-4 py-2"><span
                                                            class="bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full text-xxs">‰∏ãÂçïÊòéÊòæÂèòÂ∞ë</span>
                                                    </td>
                                                    <td class="px-4 py-2 text-right text-gray-400">60k <i
                                                            class="fa-solid fa-arrow-right text-gray-300 mx-1"></i>
                                                        <span class="text-orange-500 font-bold">25k</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="card-footer">Based on quarterly volume comparison</div>
                            </div>

                            <!-- Widget 3C: Capacity Concentration -->
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-chart-pie text-secondary"></i> <span
                                            data-i18n="p3c_title">3C.
                                            ÂìÅÁâå‰∫ßËÉΩÈõÜ‰∏≠Â∫¶</span>
                                    </h3>
                                </div>
                                <div class="p-4 flex flex-col justify-between h-full">
                                    <div class="h-32 relative">
                                        <canvas id="concentrationChart"></canvas>
                                    </div>
                                    <!-- Risk Warning -->
                                    <div class="mt-2 text-xs border-l-2 border-ora-danger pl-2 text-gray-600">
                                        <span class="font-bold text-ora-danger">High Risk:</span> ÂΩìÂâçÂâç‰∏âÂ§ßÂÆ¢Êà∑Âç†Áî®Êéí‰∫ß‰∫ßËÉΩÁ∫¶
                                        72%ÔºåÈõÜ‰∏≠Â∫¶ÂÅèÈ´ò„ÄÇ
                                    </div>
                                </div>
                                <div class="card-footer">Based on scheduled units</div>
                            </div>

                            <!-- Widget 3D: White Space Matrix (PRD 4.4) -->
                            <div class="card lg:col-span-3">
                                <div class="card-header">
                                    <h3 class="card-title"><i class="fa-solid fa-border-all text-teal-600"></i> P3-D.
                                        ÂâÇÂûãÁôΩÂú∞
                                        (White Space)</h3>
                                    <div class="flex items-center gap-2 text-xxs">
                                        <span class="w-3 h-3 bg-teal-600 rounded-sm"></span> Ê†∏ÂøÉ‰∏öÂä°
                                        <span class="w-3 h-3 bg-teal-100 rounded-sm"></span> ÂÅ∂Â∞îÁîü‰∫ß
                                        <span class="w-3 h-3 border border-gray-300 border-dashed rounded-sm"></span>
                                        ‰ªéÊú™Âêà‰Ωú
                                    </div>
                                </div>
                                <div class="p-4 overflow-x-auto">
                                    <table class="w-full text-xs text-center border-collapse">
                                        <thead>
                                            <tr>
                                                <th class="px-3 py-2 text-left font-bold text-gray-600 bg-gray-50 w-40">
                                                    ÂìÅÁâå /
                                                    ÂâÇÂûã
                                                </th>
                                                <th class="px-1 py-2 font-medium text-gray-500 bg-gray-50">Gummies</th>
                                                <th class="px-1 py-2 font-medium text-gray-500 bg-gray-50">Powder</th>
                                                <th class="px-1 py-2 font-medium text-gray-500 bg-gray-50">Liquids</th>
                                                <th class="px-1 py-2 font-medium text-gray-500 bg-gray-50">Capsules</th>
                                            </tr>
                                        </thead>
                                        <tbody class="text-gray-600">
                                            <tr class="border-b border-gray-50">
                                                <td class="p-3 text-left font-bold">Little Umbrella</td>
                                                <td class="p-1">
                                                    <div class="bg-teal-600 text-white py-2 rounded shadow-sm"
                                                        title="Volume > strong_threshold in last 2y">Ê†∏ÂøÉ‰∏öÂä°</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="bg-teal-100 text-teal-800 py-2 rounded"
                                                        title="Volume between 0 and threshold">ÂÅ∂Â∞îÁîü‰∫ß</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="border border-dashed border-gray-300 text-gray-300 py-2 rounded hover:bg-gray-50 cursor-pointer"
                                                        title="No production in last 2y">
                                                        ‰ªéÊú™Âêà‰Ωú</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="border border-dashed border-gray-300 text-gray-300 py-2 rounded hover:bg-gray-50 cursor-pointer"
                                                        title="No production in last 2y">
                                                        ‰ªéÊú™Âêà‰Ωú</div>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td class="p-3 text-left font-bold">PowerGums</td>
                                                <td class="p-1">
                                                    <div class="bg-teal-600 text-white py-2 rounded shadow-sm"
                                                        title="Volume > strong_threshold in last 2y">Strong</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="border border-dashed border-gray-300 text-gray-300 py-2 rounded hover:bg-gray-50 cursor-pointer"
                                                        title="No production in last 2y">Gap</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="border border-dashed border-gray-300 text-gray-300 py-2 rounded hover:bg-gray-50 cursor-pointer"
                                                        title="No production in last 2y">Gap</div>
                                                </td>
                                                <td class="p-1">
                                                    <div class="border border-dashed border-gray-300 text-gray-300 py-2 rounded hover:bg-gray-50 cursor-pointer"
                                                        title="No production in last 2y">Gap</div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                        </div>
                    </section>
                </div>
            </div>

            <!-- PAGE: CONTRACT TABLE -->
            <div id="page-contracts" class="hidden flex-1 flex flex-col overflow-hidden relative h-full bg-white">
                <!-- Contract Content (Scrollable) -->
                <div class="flex-1 overflow-auto bg-white relative p-4">
                    <!-- Header Controls -->
                    <div class="mb-4">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                            <div>
                                <h1 class="text-xl font-bold text-gray-900" data-i18n="ct_title">Contract Table</h1>
                                <p class="text-xs text-gray-500" data-i18n="ct_date_range">2024-06-01 ~ 2024-08-31</p>
                            </div>

                            <div class="flex flex-wrap gap-2 items-center">
                                <div class="relative">
                                    <input type="text" placeholder="Search contracts..."
                                        class="text-sm border-gray-300 rounded-md shadow-sm pl-8 pr-3 py-1.5 focus:border-[#297A88] focus:ring focus:ring-[#297A88] focus:ring-opacity-20"
                                        data-i18n="ct_search">
                                    <i
                                        class="fa-solid fa-magnifying-glass absolute left-2.5 top-2 text-gray-400 text-xs"></i>
                                </div>

                                <button
                                    class="bg-[#297A88] text-white px-4 py-1.5 rounded text-sm hover:bg-[#066070] transition shadow-sm font-bold flex items-center gap-2">
                                    <i class="fa-solid fa-plus"></i> <span data-i18n="ct_import">Import New</span>
                                </button>
                            </div>
                        </div>

                        <!-- Toolbar -->
                        <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                            <!-- Left Filters -->
                            <!-- Left Filters (Dynamic) -->
                            <div id="contract-filter-container" class="flex gap-2 w-full sm:w-auto relative z-30">
                                <!-- Rendered by JS -->
                            </div>

                            <!-- Right Role Tabs (Now Functional) -->
                            <!-- Right Role Tabs (Segmented Control) -->
                            <div class="flex items-center p-1 bg-gray-100 rounded-lg">
                                <button onclick="switchContractTab('reqs')" id="tab-ct-reqs"
                                    class="px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-[#066070] shadow-sm"
                                    data-i18n="ct_role_reqs">Reqs</button>
                                <button onclick="switchContractTab('fin')" id="tab-ct-fin"
                                    class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-700 transition-all"
                                    data-i18n="ct_role_fin">Finance</button>
                                <button onclick="switchContractTab('pkg')" id="tab-ct-pkg"
                                    class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-700 transition-all"
                                    data-i18n="ct_role_pkg">Pkg</button>
                                <button onclick="switchContractTab('plan')" id="tab-ct-plan"
                                    class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-700 transition-all"
                                    data-i18n="ct_role_plan">Plan</button>
                            </div>
                        </div>
                    </div>

                    <!-- Table Container -->
                    <div class="relative overflow-x-auto border rounded-lg border-gray-200">
                        <table class="w-full text-left border-collapse whitespace-nowrap">
                            <thead class="bg-gray-50 text-gray-500 text-xs uppercase border-b border-gray-200">
                                <tr>
                                    <!-- Fixed Columns -->
                                    <th class="px-3 py-3 font-semibold w-24" data-i18n="ct_th_date">Date</th>
                                    <th class="px-3 py-3 font-semibold w-32" data-i18n="ct_th_no">Contract No</th>
                                    <th class="px-3 py-3 font-semibold w-20" data-i18n="ct_th_brand">Brand</th>
                                    <th class="px-3 py-3 font-semibold w-40" data-i18n="ct_th_prod">Product</th>
                                    <th class="px-3 py-3 font-semibold w-24" data-i18n="ct_th_spec">Spec</th>
                                    <th class="px-3 py-3 font-semibold w-24" data-i18n="ct_th_qty">Qty</th>
                                    <th class="px-3 py-3 font-semibold w-32" data-i18n="ct_th_status">Status</th>
                                    <th class="px-3 py-3 font-semibold text-center w-10"></th>

                                    <!-- Dynamic Columns: Reqs -->
                                    <th class="col-reqs px-3 py-3 font-semibold border-l border-gray-200"
                                        data-i18n="ct_th_reqs_gacc">GACC</th>
                                    <th class="col-reqs px-3 py-3 font-semibold" data-i18n="ct_th_reqs_code">Coding</th>
                                    <th class="col-reqs px-3 py-3 font-semibold" data-i18n="ct_th_reqs_ship">Ship Mode
                                    </th>
                                    <th class="col-reqs px-3 py-3 font-semibold" data-i18n="ct_th_reqs_label">Label</th>
                                    <th class="col-reqs px-3 py-3 font-semibold" data-i18n="ct_th_reqs_other">Other</th>

                                    <!-- Dynamic Columns: Finance (Hidden by default) -->
                                    <th class="col-fin hidden px-3 py-3 font-semibold border-l border-gray-200"
                                        data-i18n="ct_th_fin_inv">Invoice #</th>
                                    <th class="col-fin hidden px-3 py-3 font-semibold" data-i18n="ct_th_fin_dep">Deposit
                                    </th>
                                    <th class="col-fin hidden px-3 py-3 font-semibold" data-i18n="ct_th_fin_pre">
                                        Pre-Prod</th>
                                    <th class="col-fin hidden px-3 py-3 font-semibold" data-i18n="ct_th_fin_bal">Balance
                                    </th>

                                    <!-- Dynamic Columns: Pkg (Hidden by default) -->
                                    <th class="col-pkg hidden px-3 py-3 font-semibold border-l border-gray-200"
                                        data-i18n="ct_th_pkg_inv">Invoice #</th>
                                    <th class="col-pkg hidden px-3 py-3 font-semibold" data-i18n="ct_th_pkg_dep">Deposit
                                    </th>
                                    <th class="col-pkg hidden px-3 py-3 font-semibold" data-i18n="ct_th_pkg_pre">
                                        Pre-Prod</th>
                                    <th class="col-pkg hidden px-3 py-3 font-semibold" data-i18n="ct_th_pkg_bal">Balance
                                    </th>

                                    <!-- Dynamic Columns: Plan (Hidden by default) -->
                                    <th class="col-plan hidden px-3 py-3 font-semibold border-l border-gray-200"
                                        data-i18n="ct_th_plan_mat">Material Stock</th>
                                    <th class="col-plan hidden px-3 py-3 font-semibold" data-i18n="ct_th_plan_sch">
                                        Schedule Log</th>


                                </tr>
                            </thead>
                            <tbody id="ct-tbody" class="text-xs text-gray-700 divide-y divide-gray-100 bg-white">
                                <!-- Roles generated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Report Page -->
            <div id="page-report" class="hidden flex-1 flex flex-col h-full bg-[#F5F7FA] overflow-hidden">
                <!-- Global Header -->
                <header
                    class="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 flex-shrink-0 z-20">
                    <div class="flex items-center gap-2">

                    </div>
                    <div>
                        <div
                            class="w-10 h-10 rounded-full bg-[#E0F2F1] text-[#297A88] flex items-center justify-center text-xl">
                            <i class="fa-solid fa-user"></i>
                        </div>
                    </div>
                </header>

                <!-- Content Canvas -->
                <div class="flex-1 flex flex-row p-6 gap-6 overflow-hidden">

                    <!-- Left Card: Today's Report -->
                    <div
                        class="w-[540px] bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col flex-shrink-0 overflow-hidden">

                        <!-- Card Header -->
                        <div class="p-5 border-b border-gray-100 flex flex-col gap-4">
                            <div class="flex flex-row items-start justify-between">
                                <div>
                                    <h2 class="text-2xl font-extrabold text-gray-900 tracking-tight">Today's report</h2>
                                    <div
                                        class="flex flex-row items-center text-sm text-gray-400 gap-2 mt-1 font-medium">
                                        <i
                                            class="fa-solid fa-chevron-left text-[10px] cursor-pointer hover:text-[#297A88] p-1"></i>
                                        <span>January 1, 2025</span>
                                        <i
                                            class="fa-solid fa-chevron-right text-[10px] cursor-pointer hover:text-[#297A88] p-1"></i>
                                    </div>
                                </div>
                                <div class="flex flex-row gap-3">
                                    <button id="today-report-back-btn"
                                        class="px-4 py-2 text-sm bg-white border border-gray-200 rounded-md text-gray-600 font-bold shadow-sm hover:bg-gray-50 whitespace-nowrap transition-all">Back
                                        Today</button>
                                    <button id="today-report-add-btn"
                                        class="px-4 py-2 text-sm bg-[#297A88] text-white rounded-md font-bold shadow-sm hover:bg-[#20606A] flex items-center justify-center gap-1 whitespace-nowrap transition-all">
                                        <i class="fa-solid fa-plus"></i> Add Temporary Task
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Scrollable List -->
                        <div id="report-cards-container"
                            class="flex-1 overflow-y-auto p-5 flex flex-col gap-4 bg-white">
                            <!-- Rendered by JS -->
                        </div>
                    </div>

                    <!-- Right Card: Production Calendar -->
                    <div
                        class="flex-1 bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col overflow-hidden">
                        <div class="p-5 border-b border-gray-100 flex flex-col gap-4">
                            <h2 class="text-lg font-bold text-gray-900">Production Calendar</h2>

                            <div class="flex flex-col gap-4">
                                <!-- Level 1: Machine Groups -->
                                <div id="machine-filter-container"
                                    class="flex flex-wrap items-center gap-4 text-xs font-bold text-gray-500 relative z-20">
                                    <!-- Rendered by JS -->
                                </div>

                                <!-- Level 2: Specific Lines (for Active Group) & Tools -->
                                <div id="line-toolbar-wrapper"
                                    class="flex flex-wrap items-center justify-between gap-4">
                                    <div id="line-filter-container"
                                        class="flex flex-row items-center gap-3 text-[11px] font-bold">
                                        <!-- Rendered by JS -->
                                    </div>

                                    <div class="flex flex-row items-center gap-3">
                                        <div class="relative">
                                            <i
                                                class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs"></i>
                                            <input type="text" placeholder="Contracts Number"
                                                class="pl-8 pr-3 py-1.5 text-xs border border-gray-300 rounded w-40 focus:outline-none focus:border-[#297A88] transition-colors">
                                        </div>
                                        <button
                                            class="text-xs font-bold text-gray-600 flex items-center gap-1 hover:text-gray-900 transition-colors">
                                            More <i class="fa-solid fa-chevron-down"></i>
                                        </button>
                                        <i
                                            class="fa-solid fa-gear text-gray-400 cursor-pointer hover:text-gray-600 transition-colors"></i>
                                    </div>
                                </div>
                            </div>

                            <script>
                                (function () {
                                    // --- Data Definitions ---
                                    const MACHINE_DATA = [
                                        { name: 'Square Sachet', displayName: 'Square Sachet', lines: ['Powder stick sachet', 'PSS', 'PSS R'] },
                                        { name: 'Sachet Filling', displayName: 'Sachet Fill', lines: ['SF R1', 'SF R2'] },
                                        { name: 'Tablets', displayName: 'Tablets', lines: [] },
                                        { name: 'Liquid Sachet', displayName: 'Liquid Sachet', lines: ['LS01 L', 'LS01 R', 'LS02', 'LS03', 'LS04 R'] },
                                        { name: 'Packing', displayName: 'Packing', lines: ['Bottle 1', 'Bottle 2', 'Bottle 3'] },
                                        { name: 'Hard Cap', displayName: 'Hard Cap', lines: ['Cap 1', 'Cap 2'] },
                                        { name: 'Soft Cap', displayName: 'Soft Cap', lines: ['Cap 1', 'Cap 2'] },
                                        { name: 'Pouch', displayName: 'Pouch', lines: ['Liquid Pouch'] },
                                        { name: 'Gel Candy', displayName: 'Gel Candy', lines: ['Gel Candy Blister'] }
                                    ];

                                    // --- State ---
                                    let filterState = {
                                        activeGroup: 'Liquid Sachet', // 'All' or Group Name
                                        activeLine: 'LS01 L',         // Line Name
                                        isGroupMoreOpen: false,
                                        isAllSelected: true
                                    };

                                    // DOM Elements
                                    const machineContainer = document.getElementById('machine-filter-container');
                                    const lineContainer = document.getElementById('line-filter-container');
                                    const lineToolbarWrapper = document.getElementById('line-toolbar-wrapper');
                                    const calendarThead = document.getElementById('calendar-thead');
                                    const calendarTbody = document.getElementById('calendar-tbody');
                                    const reportContainer = document.getElementById('report-cards-container');

                                    // --- Render Functions ---

                                    function renderFilters() {
                                        machineContainer.innerHTML = '';

                                        // 1. "All" Button
                                        const allBtn = document.createElement('button');
                                        const isAllActive = filterState.isAllSelected;
                                        allBtn.className = isAllActive
                                            ? 'px-3 py-1.5 bg-white border border-[#297A88] rounded text-[#297A88] shadow-sm font-bold transition-colors'
                                            : 'px-3 py-1.5 bg-white border border-gray-200 rounded text-gray-900 shadow-sm hover:bg-gray-50 font-bold transition-colors';
                                        allBtn.textContent = 'All';
                                        allBtn.onclick = () => {
                                            filterState.isAllSelected = true;
                                            renderFilters();
                                            renderLines();
                                            renderCalendarTable();
                                            renderCalendarBody();
                                        };
                                        machineContainer.appendChild(allBtn);

                                        // 2. Middle Button (Active Group or Candidate)
                                        const candidateGroupName = filterState.activeGroup || 'Liquid Sachet';
                                        const isGroupActive = !filterState.isAllSelected && filterState.activeGroup === candidateGroupName;

                                        const groupBtn = document.createElement('button');
                                        groupBtn.className = isGroupActive
                                            ? 'px-3 py-1.5 bg-white border border-[#297A88] rounded text-[#297A88] shadow-sm flex items-center gap-2 transition-colors font-bold'
                                            : 'px-3 py-1.5 hover:text-gray-900 transition-colors font-bold';

                                        const candidateData = MACHINE_DATA.find(g => g.name === candidateGroupName);
                                        const displayName = candidateData ? candidateData.displayName : candidateGroupName;

                                        groupBtn.innerHTML = `${displayName} ${isGroupActive ? '<i class="fa-solid fa-chevron-down text-[10px]"></i>' : ''}`;
                                        groupBtn.onclick = () => {
                                            selectGroup(candidateGroupName);
                                        };
                                        machineContainer.appendChild(groupBtn);

                                        // 3. "More" Dropdown
                                        const otherGroups = MACHINE_DATA.filter(g => g.name !== candidateGroupName);

                                        if (otherGroups.length > 0) {
                                            const moreWrapper = document.createElement('div');
                                            moreWrapper.className = 'relative';

                                            const moreBtn = document.createElement('button');
                                            moreBtn.className = 'flex items-center gap-1 hover:text-gray-900 transition-colors cursor-pointer';
                                            moreBtn.innerHTML = `More <i class="fa-solid fa-chevron-down"></i>`;
                                            moreBtn.onclick = (e) => {
                                                e.stopPropagation();
                                                filterState.isGroupMoreOpen = !filterState.isGroupMoreOpen;
                                                renderFilters(); // Re-render to show/hide dropdown
                                            };
                                            moreWrapper.appendChild(moreBtn);

                                            if (filterState.isGroupMoreOpen) {
                                                const dropdown = document.createElement('div');
                                                dropdown.className = 'absolute top-full left-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg py-1 z-50 flex flex-col';

                                                otherGroups.forEach(group => {
                                                    const item = document.createElement('button');
                                                    item.className = 'text-left px-4 py-2 text-xs text-gray-700 hover:bg-gray-50 hover:text-[#297A88] font-medium w-full';
                                                    item.textContent = group.displayName;
                                                    item.onclick = () => {
                                                        selectGroup(group.name);
                                                    }
                                                    dropdown.appendChild(item);
                                                });

                                                const closeDropdown = (e) => {
                                                    if (!moreWrapper.contains(e.target)) {
                                                        filterState.isGroupMoreOpen = false;
                                                        renderFilters();
                                                        document.removeEventListener('click', closeDropdown);
                                                    }
                                                };
                                                setTimeout(() => document.addEventListener('click', closeDropdown), 0);

                                                moreWrapper.appendChild(dropdown);
                                            }
                                            machineContainer.appendChild(moreWrapper);
                                        }
                                    }

                                    function selectGroup(groupName) {
                                        filterState.isAllSelected = false;
                                        filterState.activeGroup = groupName;
                                        filterState.isGroupMoreOpen = false;

                                        const groupData = MACHINE_DATA.find(g => g.name === groupName);
                                        if (groupData && groupData.lines.length > 0) {
                                            filterState.activeLine = groupData.lines[0];
                                        } else {
                                            filterState.activeLine = null;
                                        }
                                        renderFilters();
                                        renderLines();
                                        renderCalendarTable();
                                        renderCalendarBody();
                                    }

                                    function renderLines() {
                                        lineContainer.innerHTML = '';
                                        lineToolbarWrapper.style.opacity = '1';
                                        lineToolbarWrapper.classList.remove('hidden');

                                        // IF ALL Selected: Show the top 5 Groups
                                        if (filterState.isAllSelected) {
                                            // Label
                                            const label = document.createElement('span');
                                            label.className = 'text-gray-400';
                                            label.textContent = 'Lines:';
                                            lineContainer.appendChild(label);

                                            const btnGroup = document.createElement('div');
                                            btnGroup.className = 'flex flex-row bg-gray-100 rounded p-1 gap-0.5';

                                            // The 5 Requested Groups
                                            const top5Names = ['Square Sachet', 'Sachet Filling', 'Tablets', 'Liquid Sachet', 'Packing'];

                                            top5Names.forEach(name => {
                                                const group = MACHINE_DATA.find(g => g.name === name);
                                                if (!group) return;

                                                const btn = document.createElement('button');
                                                // No "active" state here really, as they are switchers
                                                btn.className = 'px-3 py-1 text-gray-500 hover:text-gray-900 transition-colors font-medium';
                                                btn.textContent = group.displayName;
                                                btn.onclick = () => {
                                                    // Jump to specific table -> Select Group
                                                    selectGroup(group.name);
                                                };
                                                btnGroup.appendChild(btn);
                                            });
                                            lineContainer.appendChild(btnGroup);
                                            return;
                                        }

                                        // IF Specific Group Selected: Show its Lines
                                        const group = MACHINE_DATA.find(g => g.name === filterState.activeGroup);
                                        if (!group || group.lines.length === 0) {
                                            lineContainer.innerHTML = '<span class="text-gray-400">No specific lines</span>';
                                            return;
                                        }

                                        const label = document.createElement('span');
                                        label.className = 'text-gray-400';
                                        label.textContent = 'Lines:';
                                        lineContainer.appendChild(label);

                                        const btnGroup = document.createElement('div');
                                        btnGroup.className = 'flex flex-row bg-gray-100 rounded p-1 gap-0.5';

                                        group.lines.forEach(line => {
                                            const btn = document.createElement('button');
                                            const isActive = filterState.activeLine === line;
                                            btn.className = isActive
                                                ? 'px-3 py-1 bg-[#297A88] text-white shadow-sm rounded transition-colors'
                                                : 'px-3 py-1 text-gray-500 hover:text-gray-800 transition-colors';
                                            btn.textContent = line;
                                            btn.onclick = () => {
                                                filterState.activeLine = line;
                                                renderLines();
                                                // Ideally would scroll to line or filter table rows further
                                            };
                                            btnGroup.appendChild(btn);
                                        });
                                        lineContainer.appendChild(btnGroup);
                                    }

                                    function renderCalendarTable() {
                                        if (!calendarThead) return;
                                        calendarThead.innerHTML = '';

                                        // Determine which group to show headers for.
                                        // If All is selected, we default to showing 'Liquid Sachet' headers (as per previous behavior/preview) 
                                        // or maybe the first one. Let's show currently 'activeGroup' even if All is selected, 
                                        // acting as the "Default" view behind "All".

                                        const groupName = filterState.activeGroup || 'Liquid Sachet';
                                        const group = MACHINE_DATA.find(g => g.name === groupName);

                                        if (!group || group.lines.length === 0) {
                                            calendarThead.innerHTML = '<tr><th class="p-4">No data</th></tr>';
                                            return;
                                        }

                                        // Row 1: Line Headers
                                        const tr1 = document.createElement('tr');

                                        // Empty corner cell
                                        const thCorner = document.createElement('th');
                                        thCorner.className = 'w-20 border-b border-r border-gray-200 bg-white';
                                        tr1.appendChild(thCorner);

                                        group.lines.forEach((line, index) => {
                                            const th = document.createElement('th');
                                            th.colSpan = 4;
                                            th.className = `py-2.5 px-2 text-center border-b border-r border-gray-200 ${index % 2 === 0 ? 'bg-gray-50 text-gray-700' : 'bg-white text-gray-400'} tracking-wider`;
                                            th.textContent = line;
                                            tr1.appendChild(th);
                                        });
                                        calendarThead.appendChild(tr1);

                                        // Row 2: Sub-headers (Product, Task, Planned, Actual)
                                        const tr2 = document.createElement('tr');
                                        tr2.className = 'leading-tight text-gray-500 text-[9px] font-bold';

                                        const thCorner2 = document.createElement('th');
                                        thCorner2.className = 'py-2 px-2 border-b border-r border-gray-200 bg-white';
                                        tr2.appendChild(thCorner2);

                                        group.lines.forEach(() => {
                                            // 4 Columns per Line
                                            const headers = [
                                                { t: 'Product<br>Name', w: 'w-24' },
                                                { t: 'Task<br>Number', w: 'w-14' },
                                                { t: 'Planned<br>Quantity', w: 'w-16' },
                                                { t: 'Actual<br>Quantity', w: 'w-16' }
                                            ];
                                            headers.forEach(h => {
                                                const th = document.createElement('th');
                                                th.className = `py-2 px-2 border-b border-r border-gray-200 ${h.w}`;
                                                th.innerHTML = h.t;
                                                tr2.appendChild(th);
                                            });
                                        });
                                        calendarThead.appendChild(tr2);
                                    }

                                    // Initialize
                                    renderFilters(); // Renders level 1
                                    renderLines();   // Renders level 2
                                    function renderCalendarBody() {
                                        const tbody = document.getElementById('calendar-tbody');
                                        if (!tbody) return;
                                        tbody.innerHTML = '';

                                        const groupName = filterState.activeGroup || 'Liquid Sachet';
                                        const group = MACHINE_DATA.find(g => g.name === groupName);

                                        if (!group || group.lines.length === 0) {
                                            tbody.innerHTML = '<tr><td class="p-4 text-center text-gray-400">No data available for this group</td></tr>';
                                            return;
                                        }

                                        // Generate 20 days
                                        for (let i = 1; i <= 20; i++) {
                                            const day = i < 10 ? '0' + i : i;
                                            const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                                            const wd = weekDays[i % 7]; // Mock logic

                                            const tr = document.createElement('tr');
                                            tr.className = 'h-10 hover:bg-gray-50 border-b border-gray-100';

                                            // Date Cell
                                            const tdDate = document.createElement('td');
                                            tdDate.className = 'px-3 py-2 text-[11px] font-bold text-gray-500 border-r border-gray-200 bg-gray-50/30 whitespace-nowrap sticky left-0 z-10';
                                            tdDate.textContent = `01/${day} ${wd}`;
                                            tr.appendChild(tdDate);

                                            // Line Cells
                                            group.lines.forEach((line) => {
                                                // 4 Cells per Line
                                                // 1. Product Name
                                                const tdProd = document.createElement('td');
                                                tdProd.className = 'px-2 py-1 border-r border-gray-100 truncate max-w-[100px] text-gray-900';
                                                // Dummy Data for visual check
                                                if (i === 1 && line.includes('LS01 L')) {
                                                    tdProd.textContent = 'Little Umbrella';
                                                    tdProd.title = "Little Umbrella";
                                                }
                                                tr.appendChild(tdProd);

                                                // 2. Task
                                                const tdTask = document.createElement('td');
                                                tdTask.className = 'px-2 py-1 border-r border-gray-100 text-center';
                                                tr.appendChild(tdTask);

                                                // 3. Planned
                                                const tdPlan = document.createElement('td');
                                                tdPlan.className = 'px-2 py-1 border-r border-gray-100 text-center';
                                                if (i === 1 && line.includes('LS01 L')) tdPlan.textContent = '1000';
                                                tr.appendChild(tdPlan);

                                                // 4. Actual
                                                const tdAct = document.createElement('td');
                                                tdAct.className = 'px-2 py-1 border-r border-gray-200 text-center';
                                                if (i === 1 && line.includes('LS01 L')) tdAct.textContent = '800';
                                                tr.appendChild(tdAct);
                                            });

                                            tbody.appendChild(tr);
                                        }
                                    }

                                    // --- Report Data Logic ---
                                    const REPORT_DATA = [
                                        {
                                            contractNo: "LTUM-202502001", // Links to CONTRACT_DATA[0]
                                            taskNo: "T-2025-001",
                                            status: "Temporary", // Specific report status
                                            color: "#297A88",
                                            bgColor: "bg-[#297A88]",
                                            badgeBg: "bg-[#E0F7FA]",
                                            badgeText: "text-[#006064]",
                                            planned: 1000,
                                            actual: 800,
                                            isSaved: true,
                                            alert: "Remaining 200 units carried over to Jan 2"
                                        },
                                        {
                                            contractNo: "LTUM-202502002", // Links to CONTRACT_DATA[2]
                                            taskNo: "T-2025-002",
                                            status: "Pending",
                                            color: "#EF4444",
                                            bgColor: "bg-[#EF4444]",
                                            badgeBg: "bg-red-50",
                                            badgeText: "text-red-600",
                                            planned: 1000,
                                            actual: null,
                                            isSaved: false
                                        },
                                        {
                                            contractNo: "LTUM-202502003", // Links to CONTRACT_DATA[5]
                                            taskNo: "T-2025-003",
                                            status: "Production",
                                            color: "#F59E0B",
                                            bgColor: "bg-[#F59E0B]",
                                            badgeBg: "bg-orange-50",
                                            badgeText: "text-orange-600",
                                            planned: 5000,
                                            actual: 2500,
                                            isSaved: false
                                        },
                                        {
                                            contractNo: "OR-2025-088", // Links to CONTRACT_DATA[6]
                                            taskNo: "T-2025-004",
                                            status: "Done",
                                            color: "#10B981",
                                            bgColor: "bg-[#10B981]",
                                            badgeBg: "bg-green-50",
                                            badgeText: "text-green-600",
                                            planned: 2000,
                                            actual: 2000,
                                            isSaved: true
                                        }
                                    ];

                                    function renderReportCards() {
                                        if (!reportContainer) return;
                                        reportContainer.innerHTML = '';

                                        REPORT_DATA.forEach(item => {
                                            // Find linked contract info
                                            const contract = CONTRACT_DATA.find(c => c.no === item.contractNo);
                                            const productName = contract ? `${contract.brand} ${contract.product}` : 'Unknown Product';
                                            const spec = contract ? contract.qty : '';

                                            const card = document.createElement('div');
                                            // Conditional styling for "Temporary" vs others
                                            const isTemporary = item.status === 'Temporary';
                                            const borderClass = isTemporary ? 'border-orange-200' : 'border-gray-100';
                                            const opacityClass = item.status === 'Done' ? 'opacity-60 hover:opacity-100' : '';

                                            card.className = `bg-white rounded-lg border ${borderClass} shadow-sm p-4 relative overflow-hidden group hover:shadow-md transition-shadow ${opacityClass}`;

                                            // Determine Badge
                                            const badge = `<span class="px-2 py-0.5 ${item.badgeBg} ${item.badgeText} text-[10px] font-bold rounded-full">${item.status}</span>`;

                                            // Determine Actions (Save Button vs Saved State)
                                            let actionsHtml = '';
                                            if (item.isSaved) {
                                                actionsHtml = `
                                                    <div class="flex items-center gap-1 text-[#10B981] text-xs font-bold">
                                                        <i class="fa-solid fa-circle-check"></i> <span>Saved</span>
                                                    </div>
                                                `;
                                            } else {
                                                actionsHtml = `
                                                    <button class="px-4 py-1.5 bg-[#297A88] text-white text-xs font-bold rounded shadow-sm hover:bg-[#20606A]">Save</button>
                                                `;
                                            }

                                            // Alert HTML
                                            const alertHtml = item.alert ? `
                                                <div class="pl-2 mt-3 flex items-center gap-1.5 text-[11px] text-orange-600 font-bold bg-orange-50 py-1 px-2 rounded w-fit">
                                                    <i class="fa-solid fa-circle-exclamation"></i>
                                                    ${item.alert}
                                                </div>
                                            ` : '';

                                            card.innerHTML = `
                                                <div class="flex justify-between items-start mb-2 pl-2">
                                                    <div class="flex items-center gap-2">
                                                        <div class="w-2 h-2 rounded-full ${item.bgColor}"></div>
                                                        <h3 class="text-sm font-bold text-gray-900 truncate w-40" title="${productName}">${productName}</h3>
                                                    </div>
                                                    ${badge}
                                                </div>

                                                <div class="pl-2 flex flex-col gap-0.5 mb-3">
                                                    <div class="text-[11px] text-gray-400 font-medium">Contract: <span class="text-gray-500">${item.contractNo}</span></div>
                                                    <div class="text-[11px] text-gray-400 font-medium">Task: <span class="text-gray-500">${item.taskNo}</span></div>
                                                </div>

                                                <div class="pl-2 flex items-center justify-between">
                                                    <div class="flex items-center gap-2">
                                                        <div class="flex flex-col">
                                                            <span class="text-[9px] text-gray-400 uppercase font-bold tracking-wider">Actual</span>
                                                            <input type="text" value="${item.actual !== null ? item.actual : ''}" 
                                                                ${item.isSaved ? 'disabled' : ''}
                                                                class="w-16 h-8 border border-gray-${item.isSaved ? '200 bg-gray-50 text-gray-500' : '300 text-gray-800 focus:border-[#297A88]'} rounded text-center text-sm font-bold outline-none">
                                                        </div>
                                                        <span class="text-xs text-gray-400 mt-4 font-medium">/ Planned: ${item.planned}</span>
                                                    </div>
                                                    <div class="flex items-center gap-3 mt-4">
                                                        ${actionsHtml}
                                                        <i class="fa-solid fa-ellipsis text-gray-400 cursor-pointer text-lg"></i>
                                                    </div>
                                                </div>
                                                ${alertHtml}
                                            `;

                                            reportContainer.appendChild(card);
                                        });
                                    }

                                    // Button Listeners
                                    document.getElementById('today-report-back-btn')?.addEventListener('click', () => {
                                        // Mock action
                                        alert('Navigating back to Today...');
                                    });

                                    document.getElementById('today-report-add-btn')?.addEventListener('click', () => {
                                        // Mock action
                                        const newReport = {
                                            contractNo: "PG-2025-003",
                                            taskNo: `T-2025-${String(REPORT_DATA.length + 1).padStart(3, '0')}`,
                                            status: "Pending",
                                            color: "#EF4444",
                                            bgColor: "bg-[#EF4444]",
                                            badgeBg: "bg-red-50",
                                            badgeText: "text-red-600",
                                            planned: 500,
                                            actual: null,
                                            isSaved: false
                                        };
                                        REPORT_DATA.push(newReport);
                                        renderReportCards();
                                    });

                                    // Initialize
                                    renderFilters(); // Renders level 1
                                    renderLines();   // Renders level 2
                                    renderCalendarTable(); // Renders table headers
                                    renderCalendarTable(); // Renders table headers
                                    renderCalendarBody();  // Renders table body
                                    renderReportCards();   // Renders Today's Report


                                })();
                            </script>
                        </div>

                        <!-- Table Container -->
                        <div class="flex-1 overflow-auto bg-white">
                            <table class="w-full text-left border-collapse text-xs">
                                <thead id="calendar-thead"
                                    class="sticky top-0 z-10 bg-gray-50/80 backdrop-blur-sm text-gray-500 uppercase font-semibold text-[10px]">
                                    <!-- Rendered by JS -->
                                </thead>
                                </th>
                                <th class="py-2 px-2 border-b border-r border-gray-200 w-14">Task<br>Number</th>
                                <th class="py-2 px-2 border-b border-r border-gray-200 w-16">Planned<br>Quantity
                                </th>
                                <th class="py-2 px-2 border-b border-gray-200 w-16">Actual<br>Quantity</th>
                                </tr>
                                </thead>
                                <tbody id="calendar-tbody" class="divide-y divide-gray-100 text-gray-700 font-medium">
                                    <!-- Rendered by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Context Menu (Hidden by default) -->
        <div id="row-action-menu"
            class="hidden fixed z-50 w-40 bg-[#297A88] rounded-lg shadow-xl overflow-hidden p-0 transform transition-all duration-100 ease-out origin-top-right">
            <button
                class="block w-full text-left px-4 py-2 text-sm text-[#297A88] bg-white font-bold hover:bg-gray-50 border-b border-[#297A88]/10 rounded-t-lg">
                Edit Contracts
            </button>
            <button class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#066070] font-medium">
                Start Scheduling
            </button>
            <button
                class="block w-full text-left px-4 py-2 text-sm text-white hover:bg-[#E76F51] font-medium rounded-b-lg">
                Delete
            </button>
        </div>

        <!-- LOGIC -->
        <script>
            // --- Global State ---
            let currentFilter = 'all'; // Default filter

            // --- Contract Data ---
            const CONTRACT_DATA = [
                // 1. New / Contract (Red)
                {
                    date: "07/01/2025",
                    no: "LTUM-202502001",
                    brand: "Little",
                    product: "Liquid Calcium (Xylitol verison 2)",
                    spec: "10ml/sachet",
                    qty: "900,000",
                    status: "New", // mapped to new_1/new_2
                    reqs: { gacc: "‚Äî", coding: "‚Äî", ship: "FOB Shanghai", label: "‚Äî", other: "‚Äî" },
                    fin: { inv: "INV-2024001", dep: "Paid", pre: "Pending", bal: "Pending" },
                    plan: { mat: "Partial", log: "Scheduled: 2025-02-10" }
                },
                {
                    date: "07/05/2025",
                    no: "LTUM-202502005",
                    brand: "PowerGums",
                    product: "Energy Gels (Caffeine Boost)",
                    spec: "30g/pack",
                    qty: "50,000",
                    status: "New",
                    reqs: { gacc: "Check", coding: "‚Äî", ship: "FOB Shenzhen", label: "Draft", other: "‚Äî" },
                    fin: { inv: "INV-2024012", dep: "Pending", pre: "Pending", bal: "Pending" },
                    plan: { mat: "Missing", log: "TBD" }
                },

                // 2. Pending / Preparation (Red/Pending)
                {
                    date: "07/01/2025",
                    no: "LTUM-202502002",
                    brand: "Little",
                    product: "Liquid Calcium (Xylitol verison 2)",
                    spec: "10ml/sachet",
                    qty: "900,000",
                    status: "Pending",
                    reqs: { gacc: "Done", coding: "Inkjet", ship: "CIF Melbourne", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024002", dep: "Paid", pre: "Paid", bal: "Pending" },
                    plan: { mat: "Ready", log: "Batch-A start 2025/02/15" }
                },
                {
                    date: "06/28/2025",
                    no: "PG-2025-003",
                    brand: "PowerGums",
                    product: "Vitamin C Gummies (Lemon)",
                    spec: "60ct/bottle",
                    qty: "20,000",
                    status: "Pending",
                    reqs: { gacc: "Done", coding: "Laser", ship: "CIF LA", label: "Reviewing", other: "‚Äî" },
                    fin: { inv: "INV-2024009", dep: "Paid", pre: "Pending", bal: "Pending" },
                    plan: { mat: "Partial", log: "Awaiting Artwork" }
                },
                {
                    date: "06/30/2025",
                    no: "VT-2025-010",
                    brand: "Vitality",
                    product: "Protein Powder (Vanilla)",
                    spec: "1kg/tub",
                    qty: "5,000",
                    status: "Pending",
                    reqs: { gacc: "Start", coding: "Inkjet", ship: "EXW", label: "Confirmed", other: "Cert needed" },
                    fin: { inv: "INV-2024015", dep: "Pending", pre: "Pending", bal: "Pending" },
                    plan: { mat: "Ready", log: "Slot: Wk 35" }
                },

                // 3. Production / Ongoing (Amber)
                {
                    date: "07/01/2025",
                    no: "LTUM-202502003",
                    brand: "Little",
                    product: "Liquid Calcium (Xylitol verison 2)",
                    spec: "10ml/sachet",
                    qty: "900,000",
                    status: "Production",
                    reqs: { gacc: "Done", coding: "Inkjet", ship: "CIF Melbourne", label: "Confirmed", other: "Palletized" },
                    fin: { inv: "INV-2024003", dep: "Paid", pre: "Paid", bal: "Pending" },
                    plan: { mat: "Ready", log: "In Production (Stage 3)" }
                },
                {
                    date: "06/15/2025",
                    no: "OR-2025-088",
                    brand: "OraNutrition",
                    product: "Collagen Peptides",
                    spec: "300g/tub",
                    qty: "15,000",
                    status: "Production",
                    reqs: { gacc: "Done", coding: "Inkjet", ship: "CIF NY", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024005", dep: "Paid", pre: "Paid", bal: "Pending" },
                    plan: { mat: "Ready", log: "Packing Stage" }
                },
                {
                    date: "06/20/2025",
                    no: "LTUM-202502006",
                    brand: "Little",
                    product: "Zinc Drops",
                    spec: "30ml/bottle",
                    qty: "100,000",
                    status: "Production",
                    reqs: { gacc: "Done", coding: "Laser", ship: "CIF Melbourne", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024006", dep: "Paid", pre: "Paid", bal: "Pending" },
                    plan: { mat: "Ready", log: "Filling Stage" }
                },

                // 4. Done (Green)
                {
                    date: "07/01/2025",
                    no: "LTUM-202502004",
                    brand: "Little",
                    product: "Liquid Calcium (Xylitol verison 3)",
                    spec: "10ml/sachet",
                    qty: "900,000",
                    status: "Done",
                    reqs: { gacc: "Done", coding: "Inkjet", ship: "CIF Melbourne", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024004", dep: "Paid", pre: "Paid", bal: "Paid" },
                    plan: { mat: "Ready", log: "Shipped 2025-01-20" }
                },
                {
                    date: "05/10/2025",
                    no: "PG-2025-001",
                    brand: "PowerGums",
                    product: "Caffeine Mints",
                    spec: "50ct/tin",
                    qty: "100,000",
                    status: "Done",
                    reqs: { gacc: "Done", coding: "‚Äî", ship: "FOB Shenzhen", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024001", dep: "Paid", pre: "Paid", bal: "Paid" },
                    plan: { mat: "Ready", log: "Delivered" }
                },
                {
                    date: "05/20/2025",
                    no: "VT-2025-005",
                    brand: "Vitality",
                    product: "Magnesium Tablets",
                    spec: "120ct/bottle",
                    qty: "10,000",
                    status: "Done",
                    reqs: { gacc: "Done", coding: "Inkjet", ship: "CIF LA", label: "Confirmed", other: "‚Äî" },
                    fin: { inv: "INV-2024000", dep: "Paid", pre: "Paid", bal: "Paid" },
                    plan: { mat: "Ready", log: "Delivered" }
                }
            ];

            // Render Function
            function renderContractTable(filterStatus) {
                const tbody = document.getElementById('ct-tbody');
                tbody.innerHTML = '';

                let filteredData = CONTRACT_DATA;
                if (filterStatus && filterStatus !== 'all') {
                    if (filterStatus === 'pending') {
                        filteredData = CONTRACT_DATA.filter(d => d.status === 'Pending' || d.status === 'New');
                    } else if (filterStatus === 'production') {
                        filteredData = CONTRACT_DATA.filter(d => d.status === 'Production');
                    } else if (filterStatus === 'done') {
                        filteredData = CONTRACT_DATA.filter(d => d.status === 'Done');
                    } else {
                        // Add more filters if needed
                        filteredData = CONTRACT_DATA.filter(d => d.status.toLowerCase() === filterStatus.toLowerCase());
                    }
                }

                filteredData.forEach(item => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50 transition-colors border-b border-gray-100 group';

                    // Status Badge Logic
                    let statusHtml = '';
                    if (item.status === 'New') {
                        statusHtml = `
                            <div class="flex flex-row items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-[#EF4444] flex-shrink-0"></div>
                                <div class="flex flex-col leading-tight">
                                    <span class="font-bold text-gray-800" data-i18n="ct_status_new_1">New</span>
                                    <span class="text-[10px] text-gray-500" data-i18n="ct_status_new_2">Contract</span>
                                </div>
                            </div>`;
                    } else if (item.status === 'Pending') {
                        statusHtml = `
                            <div class="flex flex-row items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-[#EF4444] flex-shrink-0"></div>
                                <div class="flex flex-col leading-tight">
                                    <span class="font-bold text-gray-800" data-i18n="ct_status_pending_1">Pending</span>
                                    <span class="text-[10px] text-gray-500" data-i18n="ct_status_pending_2">Preparation</span>
                                </div>
                            </div>`;
                    } else if (item.status === 'Production') {
                        statusHtml = `
                             <div class="flex flex-row items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-[#F59E0B] flex-shrink-0"></div>
                                <div class="flex flex-col leading-tight">
                                    <span class="font-bold text-gray-800" data-i18n="ct_status_ongoing_1">Production</span>
                                    <span class="text-[10px] text-gray-500" data-i18n="ct_status_ongoing_2">On-Going</span>
                                </div>
                            </div>`;
                    } else if (item.status === 'Done') {
                        statusHtml = `
                             <div class="flex flex-row items-center gap-2">
                                <div class="w-2 h-2 rounded-full bg-[#10B981] flex-shrink-0"></div>
                                <div class="flex flex-col leading-tight">
                                    <span class="font-bold text-gray-800" data-i18n="ct_status_done">Done</span>
                                </div>
                            </div>`;
                    }

                    // Helper for Reqs (Check checkmark)
                    const reqItem = (txt, cls = "") => {
                        if (txt === 'Done' || txt === 'Confirmed' || txt === 'Paid' || txt === 'Check') {
                            return `<span class="text-green-600"><i class="fa-solid fa-check"></i> ${txt}</span>`;
                        } else if (txt === 'Pending') {
                            return `<span class="text-gray-400">Pending</span>`;
                        }
                        return `<span class="${cls}">${txt}</span>`;
                    };

                    tr.innerHTML = `
                        <td class="px-3 py-2 text-gray-500 whitespace-nowrap">${item.date}</td>
                        <td class="px-3 py-2 font-medium whitespace-gray-800">${item.no}</td>
                        <td class="px-3 py-2 whitespace-nowrap">${item.brand}</td>
                        <td class="px-3 py-2 max-w-[160px] truncate" title="${item.product}">${item.product}</td>
                        <td class="px-3 py-2 text-gray-500">${item.spec}</td>
                        <td class="px-3 py-2">${item.qty}</td>
                        <td class="px-3 py-2">${statusHtml}</td>
                        <td class="px-3 py-2 text-center text-gray-500">
                            <i class="fa-solid fa-ellipsis hover:text-[#297A88] cursor-pointer p-1" onclick="toggleRowActionMenu(event, '${item.no}')"></i>
                        </td>

                        <!-- Reqs -->
                        <td class="col-reqs px-3 py-2 border-l border-gray-100 text-gray-400">${reqItem(item.reqs.gacc)}</td>
                        <td class="col-reqs px-3 py-2 text-gray-400">${item.reqs.coding}</td>
                        <td class="col-reqs px-3 py-2 font-medium">${item.reqs.ship}</td>
                        <td class="col-reqs px-3 py-2 text-gray-400">${reqItem(item.reqs.label)}</td>
                        <td class="col-reqs px-3 py-2 text-gray-400">${item.reqs.other}</td>

                        <!-- Fin -->
                        <td class="col-fin hidden px-3 py-2 border-l border-gray-100 font-mono">${item.fin.inv}</td>
                        <td class="col-fin hidden px-3 py-2">${reqItem(item.fin.dep)}</td>
                        <td class="col-fin hidden px-3 py-2">${reqItem(item.fin.pre)}</td>
                        <td class="col-fin hidden px-3 py-2">${reqItem(item.fin.bal)}</td>

                        <!-- Pkg -->
                        <td class="col-pkg hidden px-3 py-2 border-l border-gray-100 text-gray-400">‚Äî</td>
                        <td class="col-pkg hidden px-3 py-2 text-gray-400">‚Äî</td>
                        <td class="col-pkg hidden px-3 py-2 text-gray-400">‚Äî</td>
                        <td class="col-pkg hidden px-3 py-2 text-gray-400">‚Äî</td>

                        <!-- Plan -->
                        <td class="col-plan hidden px-3 py-2 border-l border-gray-100">
                             <span class="px-2 py-0.5 ${item.plan.mat === 'Ready' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded-full text-[10px]">${item.plan.mat}</span>
                        </td>
                        <td class="col-plan hidden px-3 py-2 text-gray-500">${item.plan.log}</td>


                    `;
                    tbody.appendChild(tr);
                });

                // Re-apply column visibility if needed (simplistic approach: just re-run tab switch logic if active)
                // For now, rows are regenerated with default hidden classes, so we might lose column state.
                // Better: check current active tab and remove hidden from those cols.
                // Let's simple re-trigger the current tab? define global 'currentTab'
                if (typeof currentTab !== 'undefined') {
                    switchContractTab(currentTab);
                }
            }

            // --- New Dynamic Contract Filters ---
            (function initContractFilters() {
                const FILTER_DATA = [
                    { id: 'pending', name: 'Preparation', count: 0 }, // Will be updated dynamically
                    { id: 'production', name: 'On-Going', count: 0 }, // Will be updated dynamically
                    { id: 'done', name: 'Done', count: 0 } // Will be updated dynamically
                ];

                let state = {
                    activeFilterId: 'all', // 'all' or status ID
                    isAllSelected: true,
                    isMoreOpen: false
                };

                const container = document.getElementById('contract-filter-container');

                // Expose applyFilter globally to work with existing table logic
                window.applyFilter = function (filterId) {
                    // Update internal state
                    if (filterId === 'all') {
                        state.isAllSelected = true;
                        state.activeFilterId = 'all';
                    } else {
                        state.isAllSelected = false;
                        state.activeFilterId = filterId;
                    }
                    state.isMoreOpen = false;
                    render();

                    // --- Existing Logic Integration ---
                    // Existing logic uses: currentFilter = filterType; renderContractTable();
                    // We need to map our IDs to what renderContractTable expects ('all', 'pending', 'production', 'done')
                    // Fortunately they match exactly.
                    window.currentFilter = filterId;
                    renderContractTable(filterId); // Pass filterId to renderContractTable
                };

                function render() {
                    if (!container) return; // Ensure container exists
                    container.innerHTML = '';

                    // 1. All Button
                    // Calculate Total Count
                    const totalCount = CONTRACT_DATA.length; // Use CONTRACT_DATA for total count

                    const allBtn = document.createElement('button');
                    const isAll = state.isAllSelected;
                    allBtn.className = isAll
                        ? 'bg-[#066070] text-white px-3 py-1.5 rounded-md text-xs font-bold shadow-sm transition-colors'
                        : 'bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-md text-xs hover:bg-gray-50 font-bold transition-colors';
                    allBtn.innerHTML = `All ¬∑ ${totalCount}`;
                    allBtn.onclick = () => window.applyFilter('all');
                    container.appendChild(allBtn);

                    // 2. Candidate Button (e.g., Preparation)
                    // If All selected, show the default candidate (Preparation) as inactive.
                    // If specific selected, show it as active.
                    const candidateId = state.activeFilterId === 'all' ? 'pending' : state.activeFilterId;
                    const candidate = FILTER_DATA.find(f => f.id === candidateId) || FILTER_DATA[0];
                    const isActive = !state.isAllSelected && state.activeFilterId === candidate.id;

                    const candBtn = document.createElement('button');
                    candBtn.className = isActive
                        ? 'bg-[#066070] text-white px-3 py-1.5 rounded-md text-xs font-bold shadow-sm transition-colors'
                        : 'bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-md text-xs hover:bg-gray-50 font-bold transition-colors';
                    candBtn.innerHTML = `${candidate.name} ¬∑ ${candidate.count}`;
                    candBtn.onclick = () => window.applyFilter(candidate.id);
                    container.appendChild(candBtn);

                    // 3. More Dropdown
                    const others = FILTER_DATA.filter(f => f.id !== candidate.id);
                    if (others.length > 0) {
                        const moreWrapper = document.createElement('div');
                        moreWrapper.className = 'relative';

                        const moreBtn = document.createElement('button');
                        moreBtn.className = 'bg-white border border-gray-300 text-gray-600 px-3 py-1.5 rounded-md text-xs hover:bg-gray-50 flex items-center gap-1 font-bold transition-colors';
                        moreBtn.innerHTML = `More <i class="fa-solid fa-chevron-down text-[10px]"></i>`;
                        moreBtn.onclick = (e) => {
                            e.stopPropagation();
                            state.isMoreOpen = !state.isMoreOpen;
                            render();
                        };
                        moreWrapper.appendChild(moreBtn);

                        if (state.isMoreOpen) {
                            const dropdown = document.createElement('div');
                            dropdown.className = 'absolute top-full left-0 mt-1 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-50 flex flex-col py-1';

                            others.forEach(item => {
                                const btn = document.createElement('button');
                                btn.className = 'block w-full text-left px-4 py-2 text-xs text-gray-700 hover:bg-gray-100 font-bold';
                                btn.innerHTML = `${item.name} ¬∑ ${item.count}`;
                                btn.onclick = () => window.applyFilter(item.id);
                                dropdown.appendChild(btn);
                            });

                            const close = (e) => {
                                if (!moreWrapper.contains(e.target)) {
                                    state.isMoreOpen = false;
                                    render();
                                    document.removeEventListener('click', close);
                                }
                            };
                            setTimeout(() => document.addEventListener('click', close), 0);

                            moreWrapper.appendChild(dropdown);
                        }
                        container.appendChild(moreWrapper);
                    }
                }

                // Initial Render
                render();

                // Hook into existing updateStatusCounts to keep counts fresh?
                // The existing code has `updateStatusCounts`. We should override it or hook into it.
                // Let's redefine `updateStatusCounts` to update `FILTER_DATA` and re-render.
                // Assuming updateStatusCounts is called elsewhere to refresh counts.
                window.updateStatusCounts = function () {
                    // Recalculate based on CONTRACT_DATA
                    const counts = {
                        pending: CONTRACT_DATA.filter(d => d.status === 'Pending' || d.status === 'New').length,
                        production: CONTRACT_DATA.filter(d => d.status === 'Production').length,
                        done: CONTRACT_DATA.filter(d => d.status === 'Done').length
                    };

                    const pendingParams = FILTER_DATA.find(f => f.id === 'pending');
                    if (pendingParams) pendingParams.count = counts.pending;

                    const prodParams = FILTER_DATA.find(f => f.id === 'production');
                    if (prodParams) prodParams.count = counts.production;

                    const doneParams = FILTER_DATA.find(f => f.id === 'done');
                    if (doneParams) doneParams.count = counts.done;

                    render();
                };

                // Call updateStatusCounts once to initialize counts
                window.updateStatusCounts();
            })();


            function switchContractTab(tabId) {
                // Update Buttons
                ['reqs', 'fin', 'pkg', 'plan'].forEach(t => {
                    const btn = document.getElementById(`tab-ct-${t}`);
                    if (t === tabId) {
                        btn.className = "px-4 py-1.5 rounded-md text-xs font-bold transition-all bg-white text-[#066070] shadow-sm";
                    } else {
                        btn.className = "px-4 py-1.5 rounded-md text-xs font-medium text-gray-500 hover:text-gray-700 transition-all";
                    }
                });

                // Update Columns (Header & Body)
                const allDynamicCols = document.querySelectorAll('.col-reqs, .col-fin, .col-pkg, .col-plan');
                allDynamicCols.forEach(el => el.classList.add('hidden'));

                const activeCols = document.querySelectorAll(`.col-${tabId}`);
                activeCols.forEach(el => el.classList.remove('hidden'));

                // Set currentTab for re-rendering
                window.currentTab = tabId;
            }

            // Init on Load
            document.addEventListener('DOMContentLoaded', () => {
                // Initial filter application now handled by initContractFilters and its render()
                applyFilter('all'); // This is now called by initContractFilters
                // Ensure columns are correct
                switchContractTab('reqs');
            });

            // --- Internationalization (i18n) Data ---
            const TRANSLATIONS = {
                en: {
                    // Header
                    "header_title": "OraNutrition Internal Process & Client Insights Overview",
                    "header_update": "Last Update: 2024-11-28 09:00 AM",
                    "filter_time_q4": "üìÖ Range: This Quarter (Q4)",
                    "filter_brand_all": "Brand: All",
                    "filter_line_all": "Line: All",
                    "refresh_data": "Refresh Data",

                    // Part 1
                    "p1_title": "Part 1. Internal Exception Radar",
                    "p1_subtitle": "Click cards to filter details",
                    "kpi_lead_title": "Lead Time Breach",
                    "kpi_lead_sub": "Overall Cycle > Target",
                    "kpi_pay_title": "Payment Blocked",
                    "kpi_pay_sub": "Payment Process Blocked",
                    "kpi_mat_title": "Material Risk",
                    "kpi_mat_sub": "Material Prep Risk",
                    "kpi_data_title": "Data Issues",
                    "kpi_data_sub": "Data Records Incomplete",

                    // Widget P1-B
                    "p1b_title": "P1-B. Key Contracts Stage Overview",
                    "btn_list": "List",
                    "btn_graph": "Graph",
                    "Tab_all": "All",
                    "Tab_blocker": "Blockers",
                    "Tab_delay": "Severe Delay",
                    "th_contract": "Contract / Brand",
                    "th_stage": "Current Stage",
                    "th_delay": "Max Delay",
                    "th_status": "Status / Reason",
                    "th_time": "Time (Sign/Upd)",

                    // Widget P1-C
                    "p1c_title": "P1-C. Zombie Contracts & Inventory",
                    "btn_zombie_contracts": "Inactive Contracts",
                    "btn_zombie_inventory": "Stuck Inventory",
                    "zombie_c_sub": "Inactive > 45d",
                    "zombie_i_sub": "Overdue > 7d",

                    // Widget P1-D
                    "p1d_title": "Data Quality Completeness",
                    "p1d_update": "Last Update: 10 mins ago",
                    "p1d_subtitle": "Left: Completeness, Right: Issue Types",
                    "p1d_list_title": "Issue List",
                    "p1d_filter_label": "Current Filter:",
                    "p1d_th_contract": "Contract / Product",
                    "p1d_th_issue": "Issue",
                    "p1d_th_update": "Update",
                    "p1d_empty": "Records Complete ¬∑ No Issues",
                    "p1d_footer": "Left shows overall data completeness. Right lists contracts with issues.",

                    "dq_good": "Complete (Good)",
                    "dq_bad": "Incomplete (Bad)",
                    "dq_issue_date": "Missing Shipping Date",
                    "dq_issue_qty": "Quantity Mismatch",
                    "dq_issue_logic": "Time Logic Error",
                    "dq_issue_other": "Other Missing Fields",
                    "dq_filter_all_bad": "All Issues",
                    "dq_filter_comp": "Complete ¬∑ No Action",

                    // Part 2
                    "p2_title": "Part 2. Lead Time Deep Dive",
                    "p2_subtitle": "Process Cycle vs Target",
                    "p2_banner_title": "Contract Entry Latency",
                    "p2_banner_desc": "About 15% contracts entered > 3 days after signing.",
                    "p2_banner_btn": "View Details",

                    "p3b_title": "3B. Capacity Utilization",
                    "p3b_sub": "Avg Days",
                    "p3b_footer_l": "Median Cycle: 42 Days",
                    "p3b_footer_r": "Based on completed contracts",
                    "p3b_desc": "Avg 42 days from payment to ship. Production & Shipping are longest stages.",

                    "p2_breach_title": "P2. Stage Breach Rate > Target",
                    "p2_breach_desc": "Top Bottlenecks:",
                    "p2_breach_b1": "1. Material Prep",
                    "p2_breach_b2": "2. Production",

                    "p3_adherence_title": "P3. On-Time Delivery by Line",
                    "p3_adherence_footer": "Gummies/Capsules stable. Powder often delayed.",

                    "p4_mat_title": "P4. Material Readiness on Start",
                    "p4_mat_desc": "85% batches have materials ready before start.",
                    "p4_mat_risk": "Risk Batches (Materials not ready)",

                    "g1_title": "G1. Factory Output & Efficiency",
                    "g1_sub": "Quarterly Trend",
                    "g1_desc": "Q4 Est 1.2M units (+15% QoQ). Avg lead time shortened by 3 days.",

                    "g1_kpi_vol": "Total Volume",
                    "g1_kpi_time": "Avg Lead Time",

                    // Part 3
                    "p3_title": "Part 3. Client & Capacity Radar",
                    "p3_sub": "Q3 2024 vs Q4 2024",
                    "p3a_title": "3A. Client Risk Watch",
                    "p3a_footer": "Based on quarterly volume comparison",
                    "p3a_th_brand": "Brand",
                    "p3a_th_status": "Status",
                    "p3a_th_vol": "Shipment Vol (Diff)",
                    "risk_dormant": "This Q No Order",
                    "risk_cooling": "Order Dropped",

                    "p3c_title": "3C. Brand Capacity Concentration",
                    "p3c_risk_label": "High Risk:",
                    "p3c_risk_desc": "Top 3 clients take 72% capacity.",
                    "p3c_footer": "Based on scheduled units",

                    "p3d_title": "P3-D. White Space Matrix",
                    "p3d_legend_core": "Core Biz",
                    "p3d_legend_occasional": "Occasional",
                    "p3d_legend_never": "Never",
                    "p3d_th_brand": "Brand / Format",
                    "ws_core": "Core Biz",
                    "ws_occa": "Occasional",
                    "ws_never": "Never",
                    "ws_gap": "Gap",
                    "ws_strong": "Strong",

                    // Contract Table
                    "ct_title": "Contract Table",
                    "ct_date_range": "2024-06-01 ~ 2024-08-31",
                    "ct_search": "Search contracts...",
                    "ct_import": "Import New",
                    "ct_filter_all": "All",
                    "ct_filter_pending": "Pending Scheduling",
                    "ct_filter_more": "More",
                    "ct_role_reqs": "Reqs",
                    "ct_role_fin": "Finance",
                    "ct_role_pkg": "Pkg",
                    "ct_role_plan": "Plan",
                    "ct_th_date": "Date",
                    "ct_th_no": "Contract No",
                    "ct_th_brand": "Brand",
                    "ct_th_prod": "Product",
                    "ct_th_spec": "Spec",
                    "ct_th_qty": "Qty",
                    "ct_th_status": "Status",

                    "ct_th_reqs_gacc": "GACC",
                    "ct_th_reqs_code": "Coding",
                    "ct_th_reqs_ship": "Ship Mode",
                    "ct_th_reqs_label": "Label",
                    "ct_th_reqs_other": "Other",

                    "ct_th_fin_inv": "Invoice #",
                    "ct_th_fin_dep": "Deposit",
                    "ct_th_fin_pre": "Pre-Prod",
                    "ct_th_fin_bal": "Balance",

                    "ct_th_pkg_inv": "Invoice #",
                    "ct_th_pkg_dep": "Deposit",
                    "ct_th_pkg_pre": "Pre-Prod",
                    "ct_th_pkg_bal": "Balance",

                    "ct_th_plan_mat": "Material Stock",
                    "ct_th_plan_sch": "Schedule Log",

                    "ct_status_new_1": "New",
                    "ct_status_new_2": "Contract",
                    "ct_status_pending_1": "Pending",
                    "ct_status_pending_2": "Preparation",
                    "ct_status_ongoing_1": "Production",
                    "ct_status_ongoing_2": "On-Going",
                    "ct_status_done": "Done"
                },
                zh: {
                    // Header
                    "header_title": "OraNutrition ÂÜÖÈÉ®ÊµÅÁ®ã‰∏éÂÆ¢Êà∑Ê¥ûÂØüÊÄªËßà",
                    "header_update": "‰∏äÊ¨°Êõ¥Êñ∞: 2024-11-28 09:00 AM",
                    "filter_time_q4": "üìÖ Êó∂Èó¥ËåÉÂõ¥: Êú¨Â≠£Â∫¶ (Q4)",
                    "filter_brand_all": "ÂìÅÁâå: ÂÖ®ÈÉ®",
                    "filter_line_all": "‰∫ßÁ∫øÁ±ªÂûã: ÂÖ®ÈÉ®",
                    "refresh_data": "Âà∑Êñ∞Êï∞ÊçÆ",

                    // Part 1
                    "p1_title": "Part 1. ÂÜÖÈÉ®ÂºÇÂ∏∏Èõ∑Ëææ (Internal Exception Radar)",
                    "p1_subtitle": "ÁÇπÂáªÂç°ÁâáÁ≠õÈÄâËØ¶ÊÉÖ",
                    "kpi_lead_title": "Êï¥‰ΩìÂë®ÊúüË∂ÖÂá∫ÂÜÖÈÉ®ÁõÆÊ†á",
                    "kpi_lead_sub": "SLA Stage > Target",
                    "kpi_pay_title": "Êî∂Ê¨æÁéØËäÇÊúâÈòªÂ°û",
                    "kpi_pay_sub": "Ê¨æÈ°πÂæÖÁ°ÆËÆ§ > 3 Â§©",
                    "kpi_mat_title": "Áâ©ÊñôÂáÜÂ§áÂ≠òÂú®È£éÈô©",
                    "kpi_mat_sub": "Áâ©ÊñôÊú™Âà∞+‰∏¥ËøëÊéí‰∫ß",
                    "kpi_data_title": "Êï∞ÊçÆËÆ∞ÂΩïÈúÄË°•ÂÖÖ",
                    "kpi_data_sub": "Â≠óÊÆµÁº∫Â§±/ÂºÇÂ∏∏",

                    // Widget P1-B
                    "p1b_title": "P1-B. ÂÖ≥ÈîÆËÆ¢ÂçïÈò∂ÊÆµÊÄªËßà (Key Contracts)",
                    "btn_list": "ÂàóË°®",
                    "btn_graph": "ÂõæË°®",
                    "Tab_all": "ÂÖ®ÈÉ®",
                    "Tab_blocker": "ÂæÖËß£ÂÜ≥ (Blocker)",
                    "Tab_delay": "‰∏•ÈáçË∂ÖÊó∂",
                    "th_contract": "ÂêàÂêå / ÂìÅÁâå",
                    "th_stage": "ÂΩìÂâçÈò∂ÊÆµ",
                    "th_delay": "ÊúÄ‰∏•ÈáçÈò∂ÊÆµ (Delay)",
                    "th_status": "Áä∂ÊÄÅ / ÂéüÂõ†",
                    "th_time": "Êó∂Èó¥ (Á≠æÁ∫¶/Êõ¥Êñ∞)",

                    // Widget P1-C
                    "p1c_title": "P1-C. ÂÉµÂ∞∏ÂêàÂêå‰∏éÂ∫ìÂ≠ò",
                    "btn_zombie_contracts": "ÂÅúÊªû‰∏≠ÁöÑÂêàÂêå",
                    "btn_zombie_inventory": "ÊªûÁïôÊàêÂìÅ/ÂçäÊàêÂìÅ",
                    "zombie_c_sub": "Ë∂ÖËøá 45 Â§©Êó†Êõ¥Êñ∞ (Inactive > 45d)",
                    "zombie_i_sub": "ÂèëË¥ßÈÄæÊúüË∂ÖËøá 7 Â§© (Overdue > 7d)",

                    // Widget P1-D
                    "p1d_title": "Êï∞ÊçÆËÆ∞ÂΩïÂÆåÊï¥Â∫¶ (Data Quality)",
                    "p1d_update": "Last Update: 10 mins ago",
                    "p1d_subtitle": "Â∑¶‰æßÂ±ïÁ§∫Êï¥‰ΩìÂÆåÊï¥Â∫¶ÔºåÂè≥‰æßÂ±ïÁ§∫ÈóÆÈ¢òÂàÜÂ∏É„ÄÇ‰∏ÄÊù°ËÆ∞ÂΩïÂèØËÉΩÂåÖÂê´Â§öÁßçÈóÆÈ¢ò„ÄÇ",
                    "p1d_list_title": "ÈóÆÈ¢òÂêàÂêåÂàóË°® (Issue List)",
                    "p1d_filter_label": "ÂΩìÂâçÁ≠õÈÄâ:",
                    "p1d_th_contract": "ÂêàÂêå/‰∫ßÂìÅ (Contract)",
                    "p1d_th_issue": "ÈóÆÈ¢ò (Issue)",
                    "p1d_th_update": "Êõ¥Êñ∞ (Update)",
                    "p1d_empty": "ËÆ∞ÂΩïÂÆåÊï¥ ¬∑ Êó†ÈúÄË°•ÂÖÖ",
                    "p1d_footer": "Â∑¶‰æßÂ±ïÁ§∫Êï¥‰ΩìÊï∞ÊçÆËÆ∞ÂΩïÁöÑÂÆåÊï¥Â∫¶ÔºåÂè≥‰æßÂàóÂá∫ÂÖ∑‰ΩìÊúâÈóÆÈ¢òÁöÑÂêàÂêå‰∏é‰∫ßÂìÅÔºå‰æø‰∫éÂø´ÈÄüÂõûÊ∫ØÂπ∂Ë°•ÂÖ®‰ø°ÊÅØ„ÄÇ",

                    "dq_good": "ÂÆåÊï¥ (Good)",
                    "dq_bad": "Áº∫Â§± (Bad)",
                    "dq_issue_date": "Áº∫Â∞ëÂèëË¥ßÊó•Êúü",
                    "dq_issue_qty": "Êï∞Èáè‰∏ç‰∏ÄËá¥",
                    "dq_issue_logic": "Êó∂Èó¥È°∫Â∫èÂºÇÂ∏∏",
                    "dq_issue_other": "ÂÖ∂‰ªñÂ≠óÊÆµÁº∫Â§±",
                    "dq_filter_all_bad": "ÂÖ®ÈÉ®ÈóÆÈ¢ò",
                    "dq_filter_comp": "ËÆ∞ÂΩïÂÆåÊï¥ ¬∑ Êó†ÈúÄË°•ÂÖÖ",

                    // Part 2
                    "p2_title": "Part 2. ‰∫§‰ªòÂë®ÊúüÊ∑±Â∫¶ÈÄèËßÜ (Lead Time Deep Dive)",
                    "p2_subtitle": "Process Cycle vs Target",
                    "p2_banner_title": "ÂêàÂêåÂΩïÂÖ•ÊèêÈÜí",
                    "p2_banner_desc": "Á∫¶ 15% ÁöÑÂêàÂêåÂú®Á≠æÁ∫¶Âêé 3 Â§©ÊâçÂΩïÂÖ•Á≥ªÁªü„ÄÇ",
                    "p2_banner_btn": "Êü•ÁúãÊòéÁªÜ",

                    "p3b_title": "3B. ‰∫ßËÉΩÂà©Áî®Áéá",
                    "p3b_sub": "Âπ≥ÂùáÂ§©Êï∞ (Avg Days)",
                    "p3b_footer_l": "Êï¥‰Ωì‰∏≠‰ΩçÂë®ÊúüÔºö42 Â§©",
                    "p3b_footer_r": "Âü∫‰∫éÂ∑≤ÂÆåÊàêÁöÑÂêàÂêå",
                    "p3b_desc": "ÁõÆÂâç‰ªéÊî∂ÈΩêË¥ßÊ¨æÂà∞ÂèëË¥ßÂπ≥ÂùáÁ∫¶ 42 Â§©ÔºåÂÖ∂‰∏≠Áîü‰∫ßÂíåÂèëË¥ß‰∏§‰∏™Èò∂ÊÆµËÄóÊó∂ÊúÄÈïø„ÄÇ",

                    "p2_breach_title": "P2. ÂêÑÈò∂ÊÆµË∂ÖÂá∫ÂÜÖÈÉ®ÁõÆÊ†áÁöÑÊØî‰æã",
                    "p2_breach_desc": "‰∏ªË¶ÅÁì∂È¢à (Top Bottlenecks):",
                    "p2_breach_b1": "1. Áâ©ÊñôÂáÜÂ§áÈò∂ÊÆµ",
                    "p2_breach_b2": "2. Áîü‰∫ßÈò∂ÊÆµ",

                    "p3_adherence_title": "P3. ÂêÑ‰∫ßÁ∫øÊåâÊó∂‰∫§‰ªòÊÉÖÂÜµ",
                    "p3_adherence_footer": "ËΩØÁ≥ñÂíåËÉ∂ÂõäÁöÑ‰∫§‰ªòÊúÄÁ®≥ÂÆöÔºåÁ≤âÂâÇÂª∂ËøüËæÉÂ§ö„ÄÇ",

                    "p4_mat_title": "P4. ÂºÄÂ∑•ÂâçÁâ©ÊñôÂáÜÂ§áÊÉÖÂÜµ",
                    "p4_mat_desc": "ÂΩìÂâçÁ∫¶ 85% ÁöÑÁîü‰∫ßÊâπÊ¨°Âú®ÂºÄÂ∑•ÂâçÁâ©ÊñôÂ∑≤ÂáÜÂ§áÂ∞±Áª™„ÄÇ",
                    "p4_mat_risk": "È£éÈô©ÊâπÊ¨°ÔºàÂºÄÂ∑•Êó∂Áâ©ÊñôÊú™ÂÆåÂÖ®Âà∞‰ΩçÔºâ",

                    "g1_title": "G1. Â∑•ÂéÇ‰∫ßÂá∫‰∏éÊïàÁéáÊèêÂçá",
                    "g1_sub": "Â≠£Â∫¶Âá∫Ë¥ßË∂ãÂäø",
                    "g1_desc": "Q4 È¢ÑËÆ°Âá∫Ë¥ß 120 ‰∏á‰ª∂ÔºåËæÉ‰∏äÂ≠£Â∫¶Â¢ûÈïø 15%ÔºõÂπ≥Âùá‰∫§‰ªòÊó∂Èó¥ÊØîÂàùÂßãÈò∂ÊÆµÁº©Áü≠Á∫¶ 3 Â§©„ÄÇ",

                    "g1_kpi_vol": "Êú¨Â≠£Â∫¶Âá∫Ë¥ßÊÄªÈáè",
                    "g1_kpi_time": "Âπ≥Âùá‰∫§‰ªòÊó∂Èó¥",

                    // Part 3
                    "p3_title": "Part 3. ÂÆ¢Êà∑‰∏é‰∫ßËÉΩÈõ∑Ëææ (Client & Capacity Radar)",
                    "p3_sub": "Q3 2024 vs Q4 2024",
                    "p3a_title": "3A. ÂÆ¢Êà∑È£éÈô©È¢ÑË≠¶",
                    "p3a_footer": "Based on quarterly volume comparison",
                    "p3a_th_brand": "ÂìÅÁâå",
                    "p3a_th_status": "Áä∂ÊÄÅ",
                    "p3a_th_vol": "ÊúÄËøëÂá†Â≠£Âá∫Ë¥ßÈáè (ÂØπÊØî)",
                    "risk_dormant": "Êú¨Â≠£Êú™‰∏ãÂçï",
                    "risk_cooling": "‰∏ãÂçïÊòéÊòæÂèòÂ∞ë",

                    "p3c_title": "3C. ÂìÅÁâå‰∫ßËÉΩÈõÜ‰∏≠Â∫¶",
                    "p3c_risk_label": "High Risk:",
                    "p3c_risk_desc": "ÂΩìÂâçÂâç‰∏âÂ§ßÂÆ¢Êà∑Âç†Áî®Êéí‰∫ß‰∫ßËÉΩÁ∫¶ 72%ÔºåÈõÜ‰∏≠Â∫¶ÂÅèÈ´ò„ÄÇ",
                    "p3c_footer": "Based on scheduled units",

                    "p3d_title": "P3-D. ÂâÇÂûãÁôΩÂú∞ (White Space)",
                    "p3d_legend_core": "Ê†∏ÂøÉ‰∏öÂä°",
                    "p3d_legend_occasional": "ÂÅ∂Â∞îÁîü‰∫ß",
                    "p3d_legend_never": "‰ªéÊú™Âêà‰Ωú",
                    "p3d_th_brand": "ÂìÅÁâå / ÂâÇÂûã",
                    "ws_core": "Ê†∏ÂøÉ‰∏öÂä°",
                    "ws_occa": "ÂÅ∂Â∞îÁîü‰∫ß",
                    "ws_never": "‰ªéÊú™Âêà‰Ωú",
                    "ws_gap": "Gap",
                    "ws_strong": "Strong",

                    // Contract Table
                    "ct_title": "Contract Table",
                    "ct_date_range": "2024-06-01 ~ 2024-08-31",
                    "ct_search": "Search contracts...",
                    "ct_import": "Import New",
                    "ct_filter_all": "All",
                    "ct_filter_pending": "Pending Scheduling",
                    "ct_filter_more": "More",
                    "ct_role_reqs": "Reqs",
                    "ct_role_fin": "Finance",
                    "ct_role_pkg": "Pkg",
                    "ct_role_plan": "Plan",
                    "ct_th_date": "Date",
                    "ct_th_no": "Contract No",
                    "ct_th_brand": "Brand",
                    "ct_th_prod": "Product",
                    "ct_th_spec": "Spec",
                    "ct_th_qty": "Qty",
                    "ct_th_status": "Status",

                    "ct_th_reqs_gacc": "GACC",
                    "ct_th_reqs_code": "Coding",
                    "ct_th_reqs_ship": "Ship Mode",
                    "ct_th_reqs_label": "Label",
                    "ct_th_reqs_other": "Other",

                    "ct_th_fin_inv": "Invoice #",
                    "ct_th_fin_dep": "Deposit",
                    "ct_th_fin_pre": "Pre-Prod",
                    "ct_th_fin_bal": "Balance",

                    "ct_th_pkg_inv": "Invoice #",
                    "ct_th_pkg_dep": "Deposit",
                    "ct_th_pkg_pre": "Pre-Prod",
                    "ct_th_pkg_bal": "Balance",

                    "ct_th_plan_mat": "Material Stock",
                    "ct_th_plan_sch": "Schedule Log",

                    "ct_status_new_1": "New",
                    "ct_status_new_2": "Contract",
                    "ct_status_pending_1": "Pending",
                    "ct_status_pending_2": "Preparation",
                    "ct_status_ongoing_1": "Production",
                    "ct_status_ongoing_2": "On-Going",
                    "ct_status_done": "Done"
                }
            };

            // --- Logic ---

            // --- Page Switching Logic ---
            function switchPage(pageId) {
                const dashboard = document.getElementById('page-dashboard');
                const contracts = document.getElementById('page-contracts');
                const report = document.getElementById('page-report');
                const btnDash = document.getElementById('nav-btn-dashboard');
                const btnCont = document.getElementById('nav-btn-contracts');
                const btnRept = document.getElementById('nav-btn-report');
                const sharedHeader = document.getElementById('shared-header');

                // Define Styles
                const btnActive = "w-full h-14 flex items-center justify-center bg-[#066070] transition-all shadow-inner";
                const btnInactive = "w-full h-14 flex items-center justify-center text-white/70 hover:bg-[#066070]/30 transition-all group";

                // Reset all first
                [btnDash, btnCont, btnRept].forEach(btn => {
                    if (!btn) return;
                    btn.className = btnInactive;
                    const img = btn.querySelector('img');
                    if (img) {
                        img.classList.add('opacity-70');
                        img.classList.add('group-hover:opacity-100');
                    }
                });

                // Hide all pages
                dashboard.classList.add('hidden');
                contracts.classList.add('hidden');
                if (report) report.classList.add('hidden');
                // Report page placeholder logic if exists

                let activeBtn = null;

                if (pageId === 'dashboard') {
                    dashboard.classList.remove('hidden');
                    activeBtn = btnDash;
                } else if (pageId === 'contracts') {
                    contracts.classList.remove('hidden');
                    activeBtn = btnCont;
                } else if (pageId === 'report') {
                    // Show report page
                    report.classList.remove('hidden');
                    activeBtn = btnRept;
                }

                // Toggle Shared Header
                if (pageId === 'report') {
                    sharedHeader.classList.add('hidden');
                } else {
                    sharedHeader.classList.remove('hidden');
                }

                if (activeBtn) {
                    activeBtn.className = btnActive;
                    const img = activeBtn.querySelector('img');
                    if (img) {
                        img.classList.remove('opacity-70');
                        img.classList.remove('group-hover:opacity-100');
                    }
                }
            }

            // --- Widget P1-A: KPI Filter Logic ---
            function toggleKpiFilterP1(cardId, filterType) {
                const card = document.getElementById(cardId);
                const allCards = document.querySelectorAll('.kpi-card');

                // Toggle Active State
                if (currentFilter === cardId) {
                    card.classList.remove('active-filter');
                    currentFilter = null;
                    // Reset P1-B to All
                    filterP1B('all');
                    return;
                }

                allCards.forEach(c => c.classList.remove('active-filter'));
                card.classList.add('active-filter');
                currentFilter = cardId;

                // Handle Filter Actions
                if (filterType === 'data_issue') {
                    // Scroll to P1-D
                    const p1d = document.getElementById('widget-p1d');
                    p1d.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    p1d.classList.add('target-highlight');
                    setTimeout(() => p1d.classList.remove('target-highlight'), 2000);
                    // Show all bad records
                    filterDataQuality('bad');
                } else {
                    // Scroll to P1-B
                    const p1b = document.getElementById('widget-p1b');
                    p1b.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    p1b.classList.add('target-highlight');
                    setTimeout(() => p1b.classList.remove('target-highlight'), 2000);

                    // Apply Filter to P1-B
                    if (filterType === 'leadtime') {
                        filterP1B('delay');
                    } else if (filterType === 'money') {
                        filterP1B('blocker'); // For demo, we just show blockers. In real app, filter by reason=money
                    } else if (filterType === 'materials') {
                        filterP1B('blocker');
                    }
                }
            }

            // --- Widget P1-B: Internal Filter ---
            function filterP1B(filterType) {
                // Update Buttons
                ['all', 'blocker', 'delay'].forEach(t => {
                    const btn = document.getElementById(`btn-p1b-${t}`);
                    if (t === filterType) {
                        btn.classList.remove('tab-inactive');
                        btn.classList.add('tab-active');
                    } else {
                        btn.classList.remove('tab-active');
                        btn.classList.add('tab-inactive');
                    }
                });

                // Filter Rows
                const rows = document.querySelectorAll('#p1b-tbody tr');
                rows.forEach(row => {
                    if (filterType === 'all') {
                        row.classList.remove('hidden');
                    } else if (filterType === 'blocker') {
                        if (row.classList.contains('row-blocker')) row.classList.remove('hidden');
                        else row.classList.add('hidden');
                    } else if (filterType === 'delay') {
                        if (row.classList.contains('row-delay')) row.classList.remove('hidden');
                        else row.classList.add('hidden');
                    }
                });
            }

            // --- View Switching (List vs Graph) ---
            function switchView(widgetId, viewType) {
                const btnList = document.getElementById(`btn-${widgetId}-view-list`);
                const btnGraph = document.getElementById(`btn-${widgetId}-view-graph`);
                const viewList = document.getElementById(`${widgetId}-view-list`);
                const viewGraph = document.getElementById(`${widgetId}-view-graph`);

                if (viewType === 'list') {
                    btnList.className = 'px-2 py-0.5 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200';
                    btnGraph.className = 'px-2 py-0.5 text-xs rounded text-gray-500 hover:text-gray-800';
                    viewList.classList.remove('hidden');
                    viewGraph.classList.add('hidden');
                } else {
                    btnList.className = 'px-2 py-0.5 text-xs rounded text-gray-500 hover:text-gray-800';
                    btnGraph.className = 'px-2 py-0.5 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200';
                    viewList.classList.add('hidden');
                    viewGraph.classList.remove('hidden');
                }
            }

            // --- Widget P1-D: Data Quality Filter (Refactored for i18n) ---
            function filterDataQuality(type) {
                const tbody = document.getElementById('p1d-tbody');
                const rows = tbody.querySelectorAll('tr');
                const emptyState = document.getElementById('p1d-empty-state');
                const filterLabel = document.getElementById('p1d-current-filter');
                const tableContainer = tbody.parentElement; // table element

                // Get Current Lang
                const params = new URLSearchParams(window.location.search);
                const lang = params.get('lang') || 'en';
                const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];

                // Reset View
                tableContainer.classList.remove('hidden');
                emptyState.classList.add('hidden');

                // Update Label using global TRANSLATIONS
                const labelMap = {
                    'good': t['dq_filter_comp'] || 'Complete',
                    'bad': t['dq_filter_all_bad'] || 'All Issues',
                    'date': t['dq_issue_date'] || 'Date',
                    'qty': t['dq_issue_qty'] || 'Qty',
                    'logic': t['dq_issue_logic'] || 'Logic',
                    'other': t['dq_issue_other'] || 'Other'
                };

                const currentFilterText = t['p1d_filter_label'] || "Current Filter:";
                filterLabel.textContent = `${currentFilterText} ${labelMap[type] || type}`;

                if (type === 'good') {
                    tableContainer.classList.add('hidden');
                    emptyState.classList.remove('hidden');
                    return;
                }

                // Filter Rows
                let visibleCount = 0;
                rows.forEach(row => {
                    if (type === 'bad') {
                        row.classList.remove('hidden');
                        visibleCount++;
                    } else {
                        if (row.classList.contains(`row-issue-${type}`)) {
                            row.classList.remove('hidden');
                            visibleCount++;
                        } else {
                            row.classList.add('hidden');
                        }
                    }
                });
            }

            // --- Contract Table Tab Switching ---
            function switchContractTab(tab) {
                // Update Buttons
                ['reqs', 'fin', 'pkg', 'plan'].forEach(t => {
                    const btn = document.getElementById(`tab-ct-${t}`);
                    if (t === tab) {
                        btn.className = "px-3 py-1 rounded-md bg-white text-[#006064] shadow-sm transition-all font-bold";
                    } else {
                        btn.className = "px-3 py-1 rounded-md hover:bg-white/50 text-gray-500 transition-all font-normal";
                    }
                });

                // Update Columns (Header & Body)
                const allDynamicCols = document.querySelectorAll('.col-reqs, .col-fin, .col-pkg, .col-plan');
                allDynamicCols.forEach(el => el.classList.add('hidden'));

                const activeCols = document.querySelectorAll(`.col-${tab}`);
                activeCols.forEach(el => el.classList.remove('hidden'));
            }

            // --- Widget P1-C: Zombie View Logic ---
            function toggleZombieView(view) {
                const btnC = document.getElementById('btn-zombie-contracts');
                const btnI = document.getElementById('btn-zombie-inventory');
                const viewC = document.getElementById('view-zombie-contracts');
                const viewI = document.getElementById('view-zombie-inventory');

                if (view === 'contracts') {
                    btnC.className = 'px-3 py-1 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200';
                    btnI.className = 'px-3 py-1 text-xs rounded text-gray-500 hover:text-gray-800';
                    viewC.classList.remove('hidden');
                    viewI.classList.add('hidden');
                } else {
                    btnC.className = 'px-3 py-1 text-xs rounded text-gray-500 hover:text-gray-800';
                    btnI.className = 'px-3 py-1 text-xs rounded bg-white shadow-sm font-bold text-gray-800 border border-gray-200';
                    viewC.classList.add('hidden');
                    viewI.classList.remove('hidden');
                }
            }

            // --- Charts and Localization Initialization ---
            document.addEventListener('DOMContentLoaded', () => {

                // Current Lang
                const params = new URLSearchParams(window.location.search);
                const lang = params.get('lang') || 'en';
                const t = TRANSLATIONS[lang] || TRANSLATIONS['en'];

                function applyLocalization() {
                    const params = new URLSearchParams(window.location.search);
                    const lang = params.get('lang') || 'en';
                    const tMap = TRANSLATIONS[lang] || TRANSLATIONS.en;

                    if (tMap) {
                        document.querySelectorAll('[data-i18n]').forEach(el => {
                            const key = el.getAttribute('data-i18n');
                            if (tMap[key]) {
                                // Check if it's an input/placeholder or text
                                if (el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
                                    el.setAttribute('placeholder', tMap[key]);
                                } else if (el.tagName === 'INPUT' && el.type === 'button') {
                                    el.value = tMap[key];
                                } else {
                                    // Handle HTML content for line breaks if needed, though textContent is safer. 
                                    // Given some keys have <br>, use innerHTML for specific status keys
                                    if (key.includes('status') || key === 'p2_banner_desc') {
                                        el.innerHTML = tMap[key];
                                    } else {
                                        el.textContent = tMap[key];
                                    }
                                }
                            }
                        });
                    }
                }

                function initCharts() {
                    // Register DataLabels plugin globally
                    Chart.register(ChartDataLabels);
                    Chart.defaults.set('plugins.datalabels', {
                        color: '#fff',
                        font: { weight: 'bold', size: 10 },
                        display: 'auto' // Only show if fits
                    });
                    Chart.defaults.font.family = "Inter, system-ui, sans-serif";

                    // 1E: Data Quality Donut (Good vs Bad)
                    new Chart(document.getElementById('dataQualityGoodBad'), {
                        type: 'doughnut',
                        data: {
                            labels: [t['dq_good'], t['dq_bad']],
                            datasets: [{
                                data: [185, 15],
                                backgroundColor: ['#2A9D8F', '#E76F51'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            onClick: (e, activeElements) => {
                                if (activeElements.length > 0) {
                                    const index = activeElements[0].index;
                                    const type = index === 0 ? 'good' : 'bad';
                                    filterDataQuality(type);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false },
                                datalabels: { display: false }
                            }
                        }
                    });

                    // 1E: Data Quality Donut (Issue Type)
                    new Chart(document.getElementById('dataQualityChart'), {
                        type: 'doughnut',
                        data: {
                            labels: [t['dq_issue_date'], t['dq_issue_qty'], t['dq_issue_logic'], t['dq_issue_other']],
                            datasets: [{
                                data: [12, 3, 1, 1],
                                backgroundColor: ['#E76F51', '#F4A261', '#E9C46A', '#264653'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '50%',
                            layout: {
                                padding: 20 // Ensure space for outside labels
                            },
                            onClick: (e, activeElements) => {
                                if (activeElements.length > 0) {
                                    const index = activeElements[0].index;
                                    const types = ['date', 'qty', 'logic', 'other'];
                                    filterDataQuality(types[index]);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    display: true,
                                    color: '#666',
                                    anchor: 'end',
                                    align: 'end',
                                    offset: 10,
                                    font: { size: 10, weight: 'normal' },
                                    formatter: (value, ctx) => {
                                        return ctx.chart.data.labels[ctx.dataIndex];
                                    }
                                }
                            }
                        },
                        plugins: [{
                            id: 'outsideLine',
                            afterDraw: (chart) => {
                                const { ctx, chartArea: { width, height } } = chart;
                                ctx.save();

                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        if (!element.hidden) {
                                            const { x, y } = element.tooltipPosition();
                                            const center = element.getCenterPoint();
                                            const angle = element.startAngle + (element.endAngle - element.startAngle) / 2;
                                            const outerRadius = element.outerRadius;
                                            const lineLength = 10;
                                            const startX = center.x + Math.cos(angle) * outerRadius;
                                            const startY = center.y + Math.sin(angle) * outerRadius;
                                            const endX = center.x + Math.cos(angle) * (outerRadius + lineLength);
                                            const endY = center.y + Math.sin(angle) * (outerRadius + lineLength);

                                            ctx.beginPath();
                                            ctx.moveTo(startX, startY);
                                            ctx.lineTo(endX, endY);
                                            ctx.strokeStyle = '#999';
                                            ctx.lineWidth = 1;
                                            ctx.stroke();
                                        }
                                    });
                                });
                                ctx.restore();
                            }
                        }]
                    });

                    // 3A: Client Risk Bar
                    new Chart(document.getElementById('clientRiskChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Vitality', 'Muscle'],
                            datasets: [
                                { label: 'Prev Q', data: [60, 60], backgroundColor: '#E5E7EB', barPercentage: 0.6, datalabels: { color: '#666', anchor: 'end', align: 'top' } },
                                { label: 'Curr Q', data: [5, 25], backgroundColor: ['#E76F51', '#F4A261'], barPercentage: 0.6, datalabels: { color: '#666', anchor: 'end', align: 'top' } }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
                                tooltip: {
                                    callbacks: {
                                        afterBody: function (context) {
                                            const idx = context[0].dataIndex;
                                            const risk = idx === 0 ? (t['risk_dormant'] || 'Dormant') : (t['risk_cooling'] || 'Cooling');
                                            return `Risk: ${risk}\nPrev: 60k\nCurr: ${context[0].raw}k`;
                                        }
                                    }
                                },
                                datalabels: { display: true }
                            },
                            scales: { y: { display: false, max: 80 }, x: { grid: { display: false } } }
                        }
                    });

                    // 3C: Capacity Bar
                    new Chart(document.getElementById('concentrationChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Little Umbrella', 'PowerGums', 'Others'],
                            datasets: [{
                                data: [42, 30, 28],
                                backgroundColor: ['#2A9D8F', '#264653', '#E5E7EB'],
                                borderRadius: 4,
                                barPercentage: 0.5
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: { x: { display: false }, y: { grid: { display: false } } },
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#666',
                                    formatter: (value) => value + '%'
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `${context.raw}% Share`;
                                        }
                                    }
                                }
                            }
                        }
                    });

                    // P1: Waterfall 
                    new Chart(document.getElementById('p1WaterfallChart'), {
                        type: 'bar',
                        data: {
                            labels: ['S1', 'S2', 'S3', 'S4', 'S5'], // Simplified for brevity in demo, ideally translated S1..S5
                            datasets: [{
                                label: 'Days',
                                data: [
                                    [0, 5],
                                    [5, 15],
                                    [15, 20],
                                    [20, 35],
                                    [35, 42]
                                ],
                                backgroundColor: [
                                    '#2A9D8F', '#2A9D8F', '#E9C46A', '#264653', '#2A9D8F'
                                ],
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    formatter: (value) => (value[1] - value[0]) + 'd',
                                    color: '#fff',
                                    font: { weight: 'bold' }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, title: { display: true, text: 'Cumulative Days' } }
                            }
                        }
                    });

                    // P2: Breach Rate
                    new Chart(document.getElementById('p2BreachChart'), {
                        type: 'bar',
                        data: {
                            labels: ['S1', 'S2', 'S3', 'S4', 'S5'],
                            datasets: [{
                                label: 'Breach %',
                                data: [10, 68, 20, 45, 5],
                                backgroundColor: [
                                    '#2A9D8F', '#E76F51', '#E9C46A', '#E9C46A', '#2A9D8F'
                                ],
                                borderRadius: 4,
                                barPercentage: 0.6
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    formatter: (value) => value + '%',
                                    anchor: 'end',
                                    align: 'top',
                                    color: '#666'
                                }
                            },
                            scales: { y: { beginAtZero: true, max: 100 } }
                        }
                    });

                    // P3: Plan Adherence
                    new Chart(document.getElementById('p3AdherenceChart'), {
                        data: {
                            labels: ['Gummies', 'Powder', 'Liquids', 'Capsules'],
                            datasets: [
                                {
                                    type: 'bar',
                                    label: 'Adherence %',
                                    data: [95, 82, 60, 88],
                                    backgroundColor: '#264653',
                                    yAxisID: 'y',
                                    barPercentage: 0.5,
                                    borderRadius: 4,
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => value + '%'
                                    }
                                },
                                {
                                    type: 'line',
                                    label: 'Avg Delay',
                                    data: [1, 4, 12, 2],
                                    borderColor: '#E76F51',
                                    borderWidth: 2,
                                    yAxisID: 'y1',
                                    tension: 0.4,
                                    datalabels: {
                                        align: 'top',
                                        color: '#E76F51',
                                        formatter: (value) => value + 'd'
                                    }
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                            },
                            scales: {
                                y: { beginAtZero: true, max: 100, position: 'left' },
                                y1: { beginAtZero: true, position: 'right', grid: { drawOnChartArea: false } }
                            }
                        }
                    });

                    // P4: Material Readiness
                    new Chart(document.getElementById('p4MaterialChart'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Ready', 'Waiting', 'High Risk'],
                            datasets: [{
                                data: [85, 10, 5],
                                backgroundColor: ['#2A9D8F', '#E9C46A', '#E76F51'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '75%',
                            plugins: {
                                legend: { display: false },
                                datalabels: { display: false }
                            }
                        }
                    });

                    // G1: Factory Growth
                    new Chart(document.getElementById('g1GrowthChart'), {
                        data: {
                            labels: ['Q1', 'Q2', 'Q3', 'Q4'],
                            datasets: [
                                {
                                    type: 'bar',
                                    label: 'Units',
                                    data: [800000, 950000, 1050000, 1200000],
                                    backgroundColor: 'rgba(42, 157, 143, 0.6)',
                                    yAxisID: 'y',
                                    barPercentage: 0.5,
                                    borderRadius: 4,
                                    datalabels: {
                                        color: '#fff',
                                        formatter: (value) => (value / 1000) + 'k'
                                    }
                                },
                                {
                                    type: 'line',
                                    label: 'Lead Time',
                                    data: [48, 46, 45, 42],
                                    borderColor: '#264653',
                                    borderWidth: 2,
                                    yAxisID: 'y1',
                                    tension: 0.4,
                                    datalabels: {
                                        align: 'top',
                                        color: '#264653',
                                        formatter: (value) => value + 'd'
                                    }
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                            },
                            scales: {
                                y: { beginAtZero: true, position: 'left' },
                                y1: { beginAtZero: false, min: 30, position: 'right', grid: { drawOnChartArea: false } }
                            }
                        }
                    });

                } // Close initCharts

                applyLocalization();
                initCharts(); // Charts init after loc checks? Or use loc inside.
            });

            // --- Row Action Menu Logic ---
            const rowActionMenu = document.getElementById('row-action-menu');

            function toggleRowActionMenu(event, contractNo) {
                event.stopPropagation();

                // Close if already open on same row? or just move it.
                // Simple logic: always show at new position

                const btn = event.target;
                const rect = btn.getBoundingClientRect();

                // Position menu below the button, aligned to right
                // Using fixed position to avoid overflow issues
                rowActionMenu.style.top = `${rect.bottom + window.scrollY + 5}px`;
                rowActionMenu.style.left = `${rect.right - 150}px`; // Shift left to keep in viewport (approx width 150)

                rowActionMenu.classList.remove('hidden');

                console.log(`Open menu for ${contractNo}`);
            }

            // Close row menu when clicking outside
            document.addEventListener('click', (e) => {
                const menu = document.getElementById('row-action-menu');
                if (!menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                }
            });

        </script>

</body>

</html>